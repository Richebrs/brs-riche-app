
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>üíé Dashboard BRS Riche - Admin & VIP</title>

<!-- Font Awesome (icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  :root{
    --blue:#0d47a1;
    --accent:#ff9800;
    --card-bg:#fff;
    --muted:#f4f7fb;
    --vip-red:#e74c3c;
  }
  html,body{height:100%;margin:0;padding:0;font-family: 'Segoe UI', Roboto, Arial, sans-serif;background:var(--muted);color:#222; -webkit-font-smoothing:antialiased;}
  header{background:var(--blue);color:#fff;padding:18px 16px;position:relative;text-align:center;}
  header h1{margin:0;font-size:1.5rem;}
  header .user-info{margin-top:8px;font-size:0.95rem;opacity:0.95;}
  .lang-dropdown{position:absolute;top:18px;right:18px;}
  .lang-btn{cursor:pointer;font-size:1.2rem;}
  .lang-menu{display:none;position:absolute;right:0;top:110%;background:#fff;color:#333;border-radius:8px;box-shadow:0 6px 20px rgba(0,0,0,0.12);min-width:140px;z-index:40;}
  .lang-menu div{padding:8px 12px;cursor:pointer;}
  .lang-menu div:hover{background:#f2f2f2;}

  .balance-card{background:var(--card-bg);margin:18px; padding:18px;border-radius:14px;box-shadow:0 8px 22px rgba(0,0,0,0.08);display:flex;gap:18px;justify-content:space-between;}
  .balance-box{flex:1;text-align:center;}
  .balance-box h3{margin:0;color:var(--blue);font-size:0.95rem;}
  .balance-box p{margin:8px 0 0;font-size:1.3rem;font-weight:700;}

  .history-btn{display:inline-block;margin:8px 18px;padding:12px 14px;background:var(--accent);color:#fff;border-radius:12px;text-decoration:none;font-weight:700;box-shadow:0 6px 14px rgba(0,0,0,0.12);}

  .menu{display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:14px;margin:18px;}
  .menu a{background:linear-gradient(180deg,#ffd54a,#ffcc00);color:var(--blue);border-radius:14px;text-align:center;font-weight:800;text-decoration:none;padding:18px 10px;box-shadow:0 8px 18px rgba(0,0,0,0.08);display:flex;flex-direction:column;align-items:center;gap:6px;transition:transform .18s,box-shadow .18s;}
  .menu a i{font-size:1.6rem;}
  .menu a:hover{transform:translateY(-6px);box-shadow:0 18px 30px rgba(0,0,0,0.12);}

  .presentation-btn{display:block;margin:18px auto;padding:12px 22px;background:var(--blue);color:#fff;border:none;border-radius:12px;font-weight:700;text-decoration:none;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);}

  .admin-menu{margin:18px;padding:14px;border-radius:12px;background:#fff;box-shadow:0 8px 20px rgba(0,0,0,0.06);}
  .admin-menu h2{margin:0 0 12px;font-size:1.05rem;color:var(--blue);}

  .users-section{margin:18px;}
  .users-table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden;box-shadow:0 8px 22px rgba(0,0,0,0.08);}
  .users-table th, .users-table td{padding:12px 10px;border-bottom:1px solid #eee;text-align:left;}
  .users-table th{background:#f6fbff;color:var(--blue);cursor:pointer;}
  .users-table tr:hover{background:#f9fbff;}
  .vip{font-weight:800;color:var(--vip-red);}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-size:0.8rem;color:#fff;margin-left:8px;}
  .solde-eleve{background:#27ae60;}
  .top-gains{background:#e67e22;}

  .btn{padding:6px 10px;border-radius:6px;border:none;cursor:pointer;font-weight:700;}
  .edit-btn{background:#2980b9;color:#fff;margin-right:6px;}
  .delete-btn{background:#c0392b;color:#fff;}

  .modal{display:none;position:fixed;z-index:60;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.45);align-items:center;justify-content:center;}
  .modal-inner{background:#fff;padding:18px;border-radius:10px;width:360px;box-shadow:0 10px 30px rgba(0,0,0,0.2);}
  .modal-inner h3{margin:0 0 12px;color:var(--blue);}
  .modal-inner label{font-size:.9rem;margin-top:8px;display:block;}
  .modal-inner input{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid #ddd;}
  .modal-actions{display:flex;gap:8px;margin-top:12px;}
  .save-btn{flex:1;background:#27ae60;color:#fff;border:none;padding:10px;border-radius:8px;font-weight:800;}
  .cancel-btn{flex:1;background:#e0e0e0;color:#333;border:none;padding:10px;border-radius:8px;font-weight:700;}

  @media(max-width:720px){
    .balance-card{flex-direction:column;gap:12px;}
    .menu{grid-template-columns:repeat(auto-fit,minmax(110px,1fr));}
    .modal-inner{width:92%;}
  }

  body[hidden]{display:none;}
</style>
</head>
<body hidden>

<header>
  <h1 id="title">üíé Dashboard BRS Riche</h1>
  <div class="user-info" id="user-info">...</div>

  <div class="lang-dropdown">
    <span class="lang-btn">üåê</span>
    <div class="lang-menu" id="lang-menu">
      <div data-lang="fr">üá´üá∑ Fran√ßais</div>
      <div data-lang="en">üá¨üáß English</div>
      <div data-lang="es">üá™üá∏ Espa√±ol</div>
    </div>
  </div>
</header>

<div class="balance-card" id="balance-card">
  <div class="balance-box">
    <h3 id="lbl-disponible">Disponible</h3>
    <p id="balance-available">$0.00</p>
  </div>
  <div class="balance-box">
    <h3 id="lbl-retire">Retir√©</h3>
    <p id="balance-withdrawn">$0.00</p>
  </div>
  <div class="balance-box">
    <h3 id="lbl-total">Total</h3>
    <p id="balance-total">$0.00</p>
  </div>
</div>

<a href="#" class="history-btn" id="btn-history">üìú Mes Historiques</a>

<div class="menu" id="main-menu">
  <a href="#"><i class="fas fa-wallet"></i><span id="menu-deposit">D√©p√¥t</span></a>
  <a href="#"><i class="fas fa-hand-holding-dollar"></i><span id="menu-withdraw">Retrait</span></a>
  <a href="#"><i class="fas fa-users"></i><span id="menu-referral">Parrainage</span></a>
  <a href="#"><i class="fas fa-hotel"></i><span id="menu-hotels">Hotels</span></a>
  <a href="#"><i class="fas fa-building"></i><span id="menu-residences">Residences</span></a>
  <a href="#"><i class="fas fa-home"></i><span id="menu-my-hotels">Mes Hotels</span></a>
  <a href="#"><i class="fas fa-door-closed"></i><span id="menu-my-residences">Mes Residences</span></a>
  <a href="#"><i class="fas fa-user"></i><span id="menu-profile">Profil</span></a>
</div>

<a class="presentation-btn" href="#">üìñ Pr√©sentation</a>

<div class="admin-menu" id="admin-menu" style="display:none;">
  <h2>üîê Menu Admis (Administrateur)</h2>
  <div style="display:flex;gap:10px;flex-wrap:wrap;">
    <a class="menu-admin-item" href="#" style="background:#f1f8ff;padding:12px;border-radius:10px;color:var(--blue);text-decoration:none;font-weight:800;display:flex;align-items:center;gap:10px;">
      <i class="fas fa-users-cog"></i> Gestion utilisateurs
    </a>
    <a class="menu-admin-item" href="#" style="background:#fff7ec;padding:12px;border-radius:10px;color:#b35b00;text-decoration:none;font-weight:800;display:flex;align-items:center;gap:10px;">
      <i class="fas fa-chart-line"></i> Statistiques globales
    </a>
    <a class="menu-admin-item" href="#" style="background:#f7fff6;padding:12px;border-radius:10px;color:#117a37;text-decoration:none;font-weight:800;display:flex;align-items:center;gap:10px;">
      <i class="fas fa-cog"></i> Param√®tres admin
    </a>
  </div>
</div>

<section class="users-section" id="users-section" style="display:none;">
  <h2 style="margin:18px;color:var(--blue);">üë• Utilisateurs Admis (VIP)</h2>

  <div style="margin:0 18px 12px;">
    <input type="text" id="searchInput" placeholder="Rechercher par email ou username" style="padding:10px;width:320px;border-radius:8px;border:1px solid #ddd;" />
    <button class="btn" style="margin-left:10px;background:#2980b9;color:#fff;" id="searchBtn">Rechercher</button>
  </div>

  <div style="margin:0 18px 18px;">
    <table class="users-table" id="usersTable">
      <thead>
        <tr>
          <th onclick="sortTable('email')">Email</th>
          <th onclick="sortTable('username')">Username</th>
          <th onclick="sortTable('wallet.balance')">Solde</th>
          <th onclick="sortTable('totalGains')">Total Gains</th>
          <th onclick="sortTable('totalWithdrawn')">Total Retraits</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersBody"></tbody>
    </table>
  </div>
</section>

<div id="editModal" class="modal">
  <div class="modal-inner">
    <h3>Modifier utilisateur</h3>
    <label>Username</label>
    <input id="editUsername" type="text" />
    <label>Solde</label>
    <input id="editBalance" type="number" />
    <label>Total Gains</label>
    <input id="editGains" type="number" />
    <label>Total Retraits</label>
    <input id="editWithdrawn" type="number" />
    <div class="modal-actions">
      <button class="save-btn" id="saveEditBtn">Sauvegarder</button>
      <button class="cancel-btn" id="cancelEditBtn">Annuler</button>
    </div>
  </div>
</div>

<!-- Firebase SDKs (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
/* =========================
   FIREBASE CONFIG (BRS-Riche-2)
   Remplace appId si tu as la valeur exacte (depuis la console -> param√®tres du projet -> tes applications).
   ========================= */
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:REPLACE_WITH_APP_ID" // <-- remplace par l'appId exact depuis la console
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* Traductions (m√™me que ton ancien) */
const translations = {
  fr: { title:"üíé Dashboard BRS Riche", disponible:"Disponible", retire:"Retir√©", total:"Total", history:"üìú Mes Historiques", deposit:"D√©p√¥t", withdraw:"Retrait", referral:"Parrainage", hotels:"Hotels", residences:"R√©sidences", myHotels:"Mes Hotels", myResidences:"Mes Residences", profile:"Profil", hello:"Bonjour" },
  en: { title:"üíé BRS Riche Dashboard", disponible:"Available", retire:"Withdrawn", total:"Total", history:"üìú My History", deposit:"Deposit", withdraw:"Withdraw", referral:"Referral", hotels:"Hotels", residences:"Residences", myHotels:"My Hotels", myResidences:"My Residences", profile:"Profile", hello:"Hello" },
  es: { title:"üíé Panel BRS Riche", disponible:"Disponible", retire:"Retirado", total:"Total", history:"üìú Mi Historial", deposit:"Dep√≥sito", withdraw:"Retiro", referral:"Referidos", hotels:"Hoteles", residences:"Residencias", myHotels:"Mis Hoteles", myResidences:"Mis Residencias", profile:"Perfil", hello:"Hola" }
};

function setLang(lang, userName=""){
  localStorage.setItem("lang", lang);
  const t = translations[lang] || translations.fr;
  document.getElementById("title").innerText = t.title;
  document.getElementById("lbl-disponible").innerText = t.disponible;
  document.getElementById("lbl-retire").innerText = t.retire;
  document.getElementById("lbl-total").innerText = t.total;
  document.getElementById("btn-history").innerText = t.history;
  document.getElementById("menu-deposit").innerText = t.deposit;
  document.getElementById("menu-withdraw").innerText = t.withdraw;
  document.getElementById("menu-referral").innerText = t.referral;
  document.getElementById("menu-hotels").innerText = t.hotels;
  document.getElementById("menu-residences").innerText = t.residences;
  document.getElementById("menu-my-hotels").innerText = t.myHotels;
  document.getElementById("menu-my-residences").innerText = t.myResidences;
  document.getElementById("menu-profile").innerText = t.profile;
  if(userName){
    document.getElementById("user-info").innerText = `${t.hello}, ${userName}`;
  }
}

/* Lang menu toggle */
const langBtn = document.querySelector(".lang-btn");
const langMenu = document.getElementById("lang-menu");
langBtn.addEventListener("click", ()=> { langMenu.style.display = langMenu.style.display==="block" ? "none" : "block"; });
langMenu.querySelectorAll("div").forEach(el=>{
  el.addEventListener("click", ()=>{
    const lang = el.dataset.lang;
    setLang(lang, currentUserName);
    langMenu.style.display="none";
  });
});

/* Prevent copy/cut/context menu */
document.addEventListener("copy", e=>e.preventDefault());
document.addEventListener("cut", e=>e.preventDefault());
document.addEventListener("contextmenu", e=>e.preventDefault());

let currentUserName = "";
let currentUserId = null;
let currentUserRole = null;
let isAdmin = false;

let allUsers = [];
let sortState = { col: null, asc: true };

function getNested(obj, path){
  return path.split('.').reduce((o,p)=> o? o[p] : null, obj);
}

/* Auth state */
auth.onAuthStateChanged(async user=>{
  if(!user){
    window.location.href = "login.html";
    return;
  }

  document.body.removeAttribute('hidden');

  currentUserId = user.uid;
  currentUserName = user.displayName || (user.email ? user.email.split('@')[0] : 'Utilisateur');

  const savedLang = localStorage.getItem("lang") || "fr";
  setLang(savedLang, currentUserName);

  const userRef = db.collection("users").doc(currentUserId);

  userRef.onSnapshot(async docSnap => {
    if(!docSnap.exists) return;
    const data = docSnap.data();
    currentUserRole = data.role || null;
    isAdmin = (currentUserRole === "Admis");

    document.getElementById('admin-menu').style.display = isAdmin ? 'block' : 'none';
    document.getElementById('users-section').style.display = isAdmin ? 'block' : 'none';

    const available = (data.wallet && typeof data.wallet.balance === 'number') ? data.wallet.balance : (data.balanceAvailable ?? data.balance ?? 0);
    const withdrawn = data.totalWithdrawn ?? data.balanceWithdrawn ?? 0;
    const total = (typeof data.totalGains === 'number' || typeof available === 'number') ? (available + withdrawn) : (data.balanceTotal ?? 0);

    document.getElementById("balance-available").innerText = `$${Number(available).toFixed(2)}`;
    document.getElementById("balance-withdrawn").innerText = `$${Number(withdrawn).toFixed(2)}`;
    document.getElementById("balance-total").innerText = `$${Number(total).toFixed(2)}`;

    if(isAdmin) {
      await loadAdminUsers();
    }
  });
});

/* Load admin users (role "Admis") */
async function loadAdminUsers(filter=""){
  try {
    const snapshot = await db.collection("users").get();
    allUsers = [];
    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      if(d.role !== "Admis") return;
      if(filter){
        const f = filter.toLowerCase();
        if(!((d.email||'').toLowerCase().includes(f) || (d.username||'').toLowerCase().includes(f))) return;
      }
      allUsers.push({ id: docSnap.id, ...d });
    });

    if(sortState.col){
      allUsers.sort((a,b)=>{
        const aV = sortState.col.includes('.') ? getNested(a, sortState.col) : a[sortState.col];
        const bV = sortState.col.includes('.') ? getNested(b, sortState.col) : b[sortState.col];
        if(aV < bV) return sortState.asc ? -1 : 1;
        if(aV > bV) return sortState.asc ? 1 : -1;
        return 0;
      });
    }

    renderUsersTable();
  } catch(err){
    console.error("Erreur loadAdminUsers:", err);
    alert("Erreur en chargeant les utilisateurs. Voir console.");
  }
}

function renderUsersTable(){
  const tbody = document.getElementById('usersBody');
  tbody.innerHTML = '';
  allUsers.forEach(u=>{
    const balance = (u.wallet && typeof u.wallet.balance === 'number') ? u.wallet.balance : (u.balance ?? 0);
    const gains = u.totalGains ?? 0;
    const withdrawn = u.totalWithdrawn ?? 0;

    const soldeBadge = balance > 1000 ? `<span class="badge solde-eleve">üí∞ Solde √©lev√©</span>` : '';
    const gainsBadge = gains > 5000 ? `<span class="badge top-gains">üèÜ Top Gains</span>` : '';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="vip">${escapeHtml(u.email||'--')}</td>
      <td>${escapeHtml(u.username||'--')}</td>
      <td>${Number(balance).toLocaleString()} ${soldeBadge}</td>
      <td>${Number(gains).toLocaleString()} ${gainsBadge}</td>
      <td>${Number(withdrawn).toLocaleString()}</td>
      <td>
        <button class="btn edit-btn" onclick="openEditModal('${u.id}')"><i class="fas fa-pen"></i> Edit</button>
        <button class="btn delete-btn" onclick="confirmDelete('${u.id}','${escapeJs(u.email||'')}')"><i class="fas fa-trash"></i> Del</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function sortTable(col){
  if(sortState.col === col) sortState.asc = !sortState.asc;
  else { sortState.col = col; sortState.asc = true; }
  const f = document.getElementById('searchInput').value || '';
  loadAdminUsers(f);
}
document.getElementById('searchBtn').addEventListener('click', ()=>{ const f=document.getElementById('searchInput').value; loadAdminUsers(f); });
document.getElementById('searchInput').addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ loadAdminUsers(e.target.value); } });

let editingDocId = null;
function openEditModal(docId){
  const u = allUsers.find(x=>x.id===docId);
  if(!u) return alert("Utilisateur introuvable");
  editingDocId = docId;
  document.getElementById('editUsername').value = u.username || '';
  document.getElementById('editBalance').value = (u.wallet && typeof u.wallet.balance === 'number') ? u.wallet.balance : (u.balance ?? 0);
  document.getElementById('editGains').value = u.totalGains ?? 0;
  document.getElementById('editWithdrawn').value = u.totalWithdrawn ?? 0;
  document.getElementById('editModal').style.display = 'flex';
}
document.getElementById('cancelEditBtn').addEventListener('click', ()=>{ document.getElementById('editModal').style.display='none'; editingDocId=null; });

document.getElementById('saveEditBtn').addEventListener('click', async ()=>{
  if(!editingDocId) return;
  const newUsername = document.getElementById('editUsername').value.trim();
  const newBalance = parseFloat(document.getElementById('editBalance').value) || 0;
  const newGains = parseFloat(document.getElementById('editGains').value) || 0;
  const newWithdrawn = parseFloat(document.getElementById('editWithdrawn').value) || 0;

  if(newUsername === '') return alert("Username requis");

  try{
    await db.collection('users').doc(editingDocId).update({
      username: newUsername,
      "wallet.balance": newBalance,
      totalGains: newGains,
      totalWithdrawn: newWithdrawn
    });
    document.getElementById('editModal').style.display='none';
    editingDocId = null;
    const f = document.getElementById('searchInput').value || '';
    await loadAdminUsers(f);
  } catch(err){
    console.error("Erreur saveEdit:", err);
    alert("Erreur lors de la sauvegarde. Voir console.");
  }
});

async function confirmDelete(docId, emailEscaped){
  const ok = confirm("Voulez-vous vraiment supprimer l'utilisateur : " + (emailEscaped || '') + " ? Cette action est irr√©versible.");
  if(!ok) return;
  try{
    await db.collection('users').doc(docId).delete();
    const f = document.getElementById('searchInput').value || '';
    await loadAdminUsers(f);
  } catch(err){
    console.error("Erreur deleteUser:", err);
    alert("Erreur lors de la suppression. Voir console.");
  }
}

function escapeHtml(s){
  return String(s||'').replace(/[&<>"']/g, function(m){ return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
function escapeJs(s){ return String(s||'').replace(/'/g,"\\'").replace(/"/g,'\\"'); }

document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ document.getElementById('editModal').style.display='none'; editingDocId=null; } });

/* Security reminder:
   - Les contr√¥les de r√¥le ici sont c√¥t√© client (UI). 
   - Ajoute des r√®gles Firestore pour emp√™cher update/delete si request.auth.uid n'est pas un admin.
*/
</script>

</body>
  </html>
  
