
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üëë Admin - D√©p√¥ts Utilisateurs</title>

<!-- üîó Librairies n√©cessaires -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<style>
:root{
  --primary:#0d47a1;
  --danger:#d32f2f;
  --ok:#2e7d32;
  --bg:#f4f7fb;
}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:var(--bg);
  margin:0;
  color:#222;
}
header{
  background:var(--primary);
  color:#fff;
  padding:16px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
h1{margin:0;font-size:20px;}
.search-bar{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  justify-content:center;
}
.search-bar input{
  padding:8px 12px;
  border-radius:8px;
  border:none;
  outline:none;
  width:250px;
}
.search-bar select{
  padding:8px 10px;
  border-radius:8px;
  border:none;
  outline:none;
}
.btn-refresh{
  background:#fff;
  color:var(--primary);
  border:none;
  border-radius:6px;
  padding:6px 12px;
  font-weight:600;
  cursor:pointer;
}
main{padding:15px;overflow-x:auto;}
.table{
  width:100%;
  border-collapse:collapse;
  margin-top:15px;
  background:#fff;
  border-radius:8px;
  overflow:hidden;
  box-shadow:0 1px 5px rgba(0,0,0,0.1);
}
.table th,.table td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:left;
  font-size:14px;
}
.table th{background:#e3f2fd;}
.status-pending{color:#b8860b;font-weight:600;}
.status-valid{color:var(--ok);font-weight:600;}
.status-refused{color:var(--danger);font-weight:600;}
.btn{
  border:none;
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
}
.btn-valid{background:var(--ok);color:#fff;}
.btn-refuse{background:var(--danger);color:#fff;}
.btn-sort{
  background:#fff;
  border:none;
  cursor:pointer;
  font-weight:600;
  color:var(--primary);
}
@media(max-width:600px){
  .table th,.table td{font-size:12px;padding:8px;}
}
</style>
</head>

<body>
<header>
  <h1>üëë Panneau Administrateur ‚Äî D√©p√¥ts</h1>
  <div class="search-bar">
    <input type="text" id="search" placeholder="üîç Rechercher par email ou statut...">
    <select id="filter-status">
      <option value="">Tous les statuts</option>
      <option value="En attente">En attente</option>
      <option value="Valid√©">Valid√©</option>
      <option value="Refus√©">Refus√©</option>
    </select>
    <button class="btn-sort" id="sort-amount">‚áÖ Trier par montant</button>
    <button class="btn-refresh" onclick="window.location.reload()">üîÑ Actualiser</button>
  </div>
</header>

<main>
  <table class="table">
    <thead>
      <tr>
        <th>Email</th>
        <th>Montant ($)</th>
        <th>R√©seau</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="deposits-list">
      <tr><td colspan="5" style="text-align:center;color:#777;">Chargement...</td></tr>
    </tbody>
  </table>
</main>

<script>
/* ---------------- CONFIG FIREBASE ---------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const tbody = document.getElementById("deposits-list");
const searchInput = document.getElementById("search");
const filterStatus = document.getElementById("filter-status");
const sortBtn = document.getElementById("sort-amount");
let allDeposits = [];
let sortAsc = true;

/* ---------------- AFFICHAGE LISTE ---------------- */
function renderDeposits(list){
  tbody.innerHTML = "";
  if(list.length === 0){
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#777;">Aucun d√©p√¥t trouv√©</td></tr>`;
    return;
  }
  list.forEach(d=>{
    const statusClass = 
      d.status === "Valid√©" ? "status-valid" :
      d.status === "Refus√©" ? "status-refused" : "status-pending";
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.email||"-"}</td>
      <td>${d.amount.toFixed(2)}</td>
      <td>${d.network}</td>
      <td class="${statusClass}">${d.status}</td>
      <td>
        ${d.status==="En attente" ? `
          <button class="btn btn-valid" onclick="validateDeposit('${d.id}', ${d.amount}, '${d.userId}')">Valider</button>
          <button class="btn btn-refuse" onclick="refuseDeposit('${d.id}')">Refuser</button>
        ` : ""}
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------------- RECHERCHE ET FILTRAGE ---------------- */
function applyFilters(){
  const query = searchInput.value.toLowerCase();
  const status = filterStatus.value;
  let filtered = allDeposits.filter(d=>{
    const matchText = d.email.toLowerCase().includes(query) || d.status.toLowerCase().includes(query);
    const matchStatus = status === "" || d.status === status;
    return matchText && matchStatus;
  });
  renderDeposits(filtered);
}
searchInput.addEventListener("input", applyFilters);
filterStatus.addEventListener("change", applyFilters);

/* ---------------- TRI ---------------- */
sortBtn.addEventListener("click", ()=>{
  sortAsc = !sortAsc;
  const sorted = [...allDeposits].sort((a,b)=> sortAsc ? a.amount - b.amount : b.amount - a.amount);
  renderDeposits(sorted);
});

/* ---------------- RECUP√âRATION EN TEMPS R√âEL ---------------- */
db.collection("admin_deposits").orderBy("createdAt","desc").onSnapshot(snapshot=>{
  allDeposits = [];
  snapshot.forEach(doc=>{
    allDeposits.push({ id:doc.id, ...doc.data() });
  });
  renderDeposits(allDeposits);
});

/* ---------------- ACTIONS ADMIN ---------------- */
async function validateDeposit(id, amount, userId){
  if(!confirm("Confirmer la validation et cr√©diter l‚Äôutilisateur ?")) return;
  try{
    await db.collection("admin_deposits").doc(id).update({ status:"Valid√©" });
    await db.collection("deposits").doc(id).update({ status:"Valid√©" });

    // Cr√©dit automatique
    const userRef = db.collection("users").doc(userId);
    const userDoc = await userRef.get();
    if(userDoc.exists){
      const oldBalance = userDoc.data().balance || 0;
      const newBalance = oldBalance + amount;
      await userRef.update({ balance:newBalance });
    }

    // Historique marqu√©
    await db.collection("deposits").doc(id).update({ status:"Cr√©dit√©" });
    alert("‚úÖ D√©p√¥t valid√© et solde cr√©dit√© !");
  }catch(e){
    console.error(e);
    alert("Erreur lors de la validation.");
  }
}

async function refuseDeposit(id){
  if(!confirm("Refuser ce d√©p√¥t ?")) return;
  try{
    await db.collection("admin_deposits").doc(id).update({ status:"Refus√©" });
    await db.collection("deposits").doc(id).update({ status:"Refus√©" });
    alert("‚ùå D√©p√¥t refus√© avec succ√®s.");
  }catch(e){
    console.error(e);
    alert("Erreur lors du refus.");
  }
}
</script>
</body>
</html>

  
