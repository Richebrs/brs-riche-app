<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin - Dépôts | BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f6f8; }
header { background:#1976d2; color:white; padding:15px; text-align:center; font-size:20px; }
.container { padding:20px; }
.filter { margin-bottom:15px; text-align:center; }
.filter select { padding:8px; border-radius:5px; border:1px solid #ccc; }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.card h3 { margin:0 0 10px; }
.actions { margin-top:10px; }
.btn { padding:8px 12px; margin-right:8px; border:none; border-radius:5px; cursor:pointer; color:white; }
.btn-accept { background:#2e7d32; }
.btn-refuse { background:#c62828; }
.status { font-weight:bold; margin-top:10px; }
.status.pending { color:orange; }
.status.approved { color:green; }
.status.refused { color:red; }
</style>
</head>
<body>
<header>📊 Tableau de validation des dépôts</header>

<div class="container">
  <div class="filter">
    <label for="statusFilter">Filtrer :</label>
    <select id="statusFilter">
      <option value="all">Tous</option>
      <option value="pending">En attente</option>
      <option value="approved">Acceptés</option>
      <option value="refused">Refusés</option>
    </select>
  </div>

  <div id="deposits-container">
    <p>Chargement des dépôts...</p>
  </div>
</div>

<audio id="notif-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

<script>
const firebaseConfig = {
  apiKey: "TON_API_KEY",
  authDomain: "TON_PROJET.firebaseapp.com",
  projectId: "TON_PROJET",
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const depositsContainer = document.getElementById("deposits-container");
const statusFilter = document.getElementById("statusFilter");
const notifSound = document.getElementById("notif-sound");

let currentFilter = "all";
let seenIds = new Set();

function renderDeposits(docs){
  depositsContainer.innerHTML = "";
  const filtered = docs.filter(doc=>{
    const data = doc.data();
    if(currentFilter === "all") return true;
    return data.status === currentFilter;
  });

  if(filtered.length === 0){
    depositsContainer.innerHTML = "<p>Aucune demande trouvée.</p>";
    return;
  }

  filtered.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement("div");
    card.className = "card";

    card.innerHTML = `
      <h3>👤 ${data.username || "Utilisateur inconnu"}</h3>
      <p>Email : ${data.email || "-"}</p>
      <p>💵 Montant : <b>${data.amount}$</b></p>
      <p>🌐 Réseau : ${data.network || "-"}</p>
      <p>🔗 Hash : ${data.txHash || "Non fourni"}</p>
      <p>📅 Date : ${data.createdAt?.toDate().toLocaleString() || "-"}</p>
      <p class="status ${data.status}">Statut : ${data.status}</p>
      <div class="actions">
        <button class="btn btn-accept" onclick="updateStatus('${doc.id}','approved')">✅ Accepter</button>
        <button class="btn btn-refuse" onclick="updateStatus('${doc.id}','refused')">❌ Refuser</button>
      </div>
    `;

    depositsContainer.appendChild(card);
  });
}

// Écoute Firestore en temps réel
db.collection("deposits").orderBy("createdAt","desc")
  .onSnapshot(snapshot=>{
    renderDeposits(snapshot.docs);

    // Notification pour nouveaux dépôts en attente
    snapshot.docs.forEach(doc=>{
      if(!seenIds.has(doc.id) && doc.data().status === "pending"){
        notifSound.play();
        seenIds.add(doc.id);
      }
    });
  });

// Filtre par statut
statusFilter.addEventListener("change", e=>{
  currentFilter = e.target.value;
  db.collection("deposits").orderBy("createdAt","desc").get().then(snapshot=>{
    renderDeposits(snapshot.docs);
  });
});

// Mettre à jour le statut
function updateStatus(docId,status){
  db.collection("deposits").doc(docId).update({ status }).then(()=>{
    alert("Le dépôt a été " + (status==="approved" ? "accepté ✅" : "refusé ❌"));
  }).catch(err=>{
    console.error(err);
    alert("Erreur lors de la mise à jour du statut");
  });
}
</script>
</body>
</html>

      
