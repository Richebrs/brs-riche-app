<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin - Dépôts | BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f6f8; }
header { background:#1976d2; color:white; padding:15px; text-align:center; font-size:20px; }
.container { padding:20px; }
.filter { margin-bottom:15px; text-align:center; }
.filter select { padding:8px; border-radius:5px; border:1px solid #ccc; }
.card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
.card h3 { margin:0 0 10px; }
.actions { margin-top:10px; }
.btn { padding:8px 12px; margin-right:8px; border:none; border-radius:5px; cursor:pointer; color:white; }
.btn-accept { background:#2e7d32; }
.btn-refuse { background:#c62828; }
.status { font-weight:bold; margin-top:10px; }
.status.pending { color:orange; }
.status.approved { color:green; }
.status.refused { color:red; }
.copy-btn { background:#0d47a1; color:white; border:none; padding:4px 8px; border-radius:5px; cursor:pointer; margin-left:6px; font-size:12px; }
</style>
</head>
<body>
<header>📊 Tableau de validation des dépôts</header>

<div class="container">
  <div class="filter">
    <label for="statusFilter">Filtrer par statut :</label>
    <select id="statusFilter">
      <option value="all">Tous</option>
      <option value="En attente">En attente</option>
      <option value="Succès">Succès</option>
      <option value="Annulé">Annulé</option>
    </select>
  </div>
  <div id="deposits-container">
    <p>Chargement des dépôts...</p>
  </div>
</div>

<audio id="notif-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// --- Config Firebase identique utilisateur ---
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const depositsContainer = document.getElementById("deposits-container");
const statusFilter = document.getElementById("statusFilter");
const notifSound = document.getElementById("notif-sound");
let currentFilter = "all";
let seenIds = new Set();

function copyText(text){
  navigator.clipboard.writeText(text).then(()=>alert("Copié !"));
}

function renderDeposits(docs){
  depositsContainer.innerHTML = "";
  const filtered = docs.filter(doc=>{
    const data = doc.data();
    if(currentFilter === "all") return true;
    return data.status === currentFilter;
  });

  if(filtered.length === 0){
    depositsContainer.innerHTML = "<p>Aucun dépôt trouvé.</p>";
    return;
  }

  filtered.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement("div");
    card.className = "card";

    const statusClass = data.status === "En attente" ? "pending" :
                        data.status === "Succès" ? "approved" :
                        data.status === "Annulé" ? "refused" : "";

    let createdAt = "-";
    if(data.createdAt?.toDate) createdAt = data.createdAt.toDate().toLocaleString();
    else if(data.createdAt) createdAt = data.createdAt;

    card.innerHTML = `
      <h3>👤 ${data.email || "Utilisateur inconnu"}</h3>
      <p>💵 Montant : <b>${data.amount || "-"}</b></p>
      <p>🌐 Réseau : ${data.network || "-"}</p>
      <p>🏦 Adresse dépôt : ${data.depositAddress || "-"} <button class="copy-btn" onclick="copyText('${data.depositAddress || ""}')">Copier</button></p>
      <p>🔗 Hash / ID : ${data.txHash || "-"} <button class="copy-btn" onclick="copyText('${data.txHash || ""}')">Copier</button></p>
      <p>📅 Date : ${createdAt}</p>
      <p class="status ${statusClass}">Statut : ${data.status || "Inconnu"}</p>
      <div class="actions">
        <button class="btn btn-accept" onclick="updateStatus('${doc.id}','Succès')">✅ Accepter</button>
        <button class="btn btn-refuse" onclick="updateStatus('${doc.id}','Annulé')">❌ Refuser</button>
      </div>
    `;
    depositsContainer.appendChild(card);

    if(!seenIds.has(doc.id) && data.status === "En attente"){
      notifSound.play();
      seenIds.add(doc.id);
    }
  });
}

// --- Écoute Firestore temps réel ---
db.collection("deposits").orderBy("createdAt","desc").onSnapshot(snapshot=>{
  renderDeposits(snapshot.docs);
});

// --- Filtre statut ---
statusFilter.addEventListener("change", e=>{
  currentFilter = e.target.value;
  db.collection("deposits").orderBy("createdAt","desc").get().then(snapshot=>{
    renderDeposits(snapshot.docs);
  });
});

// --- Mettre à jour le statut ---
function updateStatus(docId,status){
  db.collection("deposits").doc(docId).update({ status }).then(()=>{
    alert("Le dépôt a été " + (status==="Succès" ? "accepté ✅" : "refusé ❌"));
  }).catch(err=>{
    console.error(err);
    alert("Erreur lors de la mise à jour du statut");
  });
}
</script>
</body>
    </html>
  
