
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>Admin D√©p√¥ts - BRS RICHE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{margin:0;font-family:"Segoe UI",Arial,sans-serif;background:#f4f7fb;color:#222;display:flex;flex-direction:column;align-items:center;}
header{background:#0d47a1;color:#fff;padding:14px 16px;width:100%;text-align:center;}
main{padding:16px;width:100%;max-width:600px;}
.card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:16px;}
.card h2{color:#0d47a1;text-align:center;margin:0 0 12px;}
.history-item{padding:12px;border-radius:8px;background:#fff;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.btn-action{margin-top:6px;padding:6px 10px;border-radius:6px;border:none;color:#fff;cursor:pointer;}
.btn-accept{background:#2e7d32;}
.btn-reject{background:#e53935;}
.status-pending{color:#b8860b;font-weight:700;}
.status-ok{color:#2e7d32;font-weight:700;}
.status-error{color:#b71c1c;font-weight:700;}
@media(max-width:520px){body{padding:0 8px;}}
</style>
</head>
<body>
<header><strong>üì• Gestion D√©p√¥ts Admin</strong></header>
<main>
  <div class="card history">
    <h2>D√©p√¥ts en attente</h2>
    <div id="deposit-list">Chargement...</div>
  </div>
</main>
<script>
/* Firebase config */
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserId = null;
const depositList = document.getElementById('deposit-list');

/* Render historique admin */
function renderDeposits(snap){
  depositList.innerHTML='';
  if(snap.empty){ depositList.innerHTML='<div>Aucun d√©p√¥t trouv√©.</div>'; return; }
  snap.forEach(doc=>{
    const d=doc.data();
    const created=d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString():'';
    const item=document.createElement('div');
    item.className='history-item';
    const statusLower=(d.status||'').toLowerCase();
    const statusClass=statusLower.includes('en attente')?'status-pending':
                      statusLower.includes('succ√®s')?'status-ok':
                      statusLower.includes('annul√©')?'status-error':'';
    item.innerHTML=`
      <div><strong>Utilisateur:</strong> ${d.email}</div>
      <div><strong>Montant:</strong> $${d.amount}</div>
      <div><strong>R√©seau:</strong> ${d.network}</div>
      <div><strong>Hash:</strong> ${d.txHash}</div>
      <div><strong>Status:</strong> <span class="${statusClass}">${d.status}</span></div>
      <div><small>${created}</small></div>
      ${d.status==="En attente" ? `
        <button class="btn-action btn-accept" onclick="acceptDeposit('${doc.id}', ${d.amount}, '${d.userId}')">‚úÖ Accepter</button>
        <button class="btn-action btn-reject" onclick="rejectDeposit('${doc.id}')">‚ùå Refuser</button>
      `:''}
    `;
    depositList.appendChild(item);
  });
}

/* Accepter d√©p√¥t et cr√©diter solde */
window.acceptDeposit=async function(docId, amount, userId){
  if(!confirm("Confirmer l'acceptation et cr√©diter le solde ?")) return;
  try{
    // Mettre √† jour le d√©p√¥t
    await db.collection('deposits').doc(docId).update({status:"Succ√®s"});
    // Ajouter le solde utilisateur
    const userRef=db.collection('users').doc(userId);
    await db.runTransaction(async t=>{
      const docUser=await t.get(userRef);
      const currentBalance=docUser.exists && docUser.data().balance?docUser.data().balance:0;
      t.set(userRef,{balance: currentBalance+amount},{merge:true});
    });
    alert('D√©p√¥t accept√© et solde cr√©dit√© ‚úÖ');
  }catch(e){console.error(e);alert('Erreur serveur.');}
}

/* Refuser d√©p√¥t */
window.rejectDeposit=async function(docId){
  if(!confirm("Confirmer le refus du d√©p√¥t ?")) return;
  try{
    await db.collection('deposits').doc(docId).update({status:"Annul√©"});
    alert('D√©p√¥t refus√© ‚ùå');
  }catch(e){console.error(e);alert('Erreur serveur.');}
}

/* Auth admin */
auth.onAuthStateChanged(user=>{
  if(!user){window.location.href='login.html';return;}
  currentUserId=user.uid;
  db.collection('deposits').orderBy('createdAt','desc').onSnapshot(renderDeposits);
});
</script>
</body>
</html>

  
