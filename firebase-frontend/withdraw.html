<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BRS Riche - Retrait</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f4f8; margin:0; padding:0; display:flex; justify-content:center; align-items:center; min-height:100vh; }
  .card { background:#fff; padding:30px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); width:350px; }
  h2 { text-align:center; color:#2c3e50; margin-bottom:20px; }
  label { display:block; margin-top:12px; font-weight:bold; }
  input, select, button { width:100%; padding:10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; font-size:14px; }
  .info { margin:10px 0; font-weight:bold; }
  .success { color:#27ae60; }
  .error { color:#e74c3c; }
  #message { text-align:center; margin-top:12px; font-weight:bold; }
</style>
</head>
<body>

<div class="card">
  <h2>üí∏ Demande de Retrait</h2>

  <div class="info">üí∞ Solde disponible : <span id="balance">0</span> USDT</div>
  <div class="info">üìà Gains totaux : <span id="gains">0</span> USDT</div>
  <div class="info">üè¶ D√©j√† retir√© : <span id="withdrawn">0</span> USDT</div>

  <label>Montant √† retirer (USDT) :</label>
  <input type="number" id="amount" placeholder="Ex: 5" min="3">

  <div class="info">Minimum de retrait : 3 USDT</div>
  <div class="info">Frais (5%) : <span id="fees">0</span> USDT</div>
  <div class="info">Net √† recevoir : <span id="net">0</span> USDT</div>

  <label>R√©seau :</label>
  <select id="network">
    <option value="TRC20">USDT TRC20</option>
    <option value="BEP20">USDT BEP20</option>
  </select>

  <label>Adresse de retrait :</label>
  <input type="text" id="walletAddress" placeholder="Votre adresse USDT">

  <button onclick="requestWithdraw()">üì§ Demander un retrait</button>
  <p id="message"></p>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let currentUserDoc;

// R√©cup√©rer l'utilisateur et ses gains r√©els
auth.onAuthStateChanged(async (user) => {
  if(user){
    const docRef = db.collection("users").doc(user.uid);
    const doc = await docRef.get();
    if(doc.exists){
      currentUserDoc = docRef;
      const data = doc.data();
      document.getElementById("balance").textContent = data.balance || 0;
      document.getElementById("gains").textContent = data.totalGains || 0;
      document.getElementById("withdrawn").textContent = data.totalWithdrawn || 0;
    }
  } else {
    document.getElementById("message").innerHTML = "<span class='error'>‚ö† Veuillez vous connecter</span>";
  }
});

// Calcul frais et net
document.getElementById("amount").addEventListener("input", ()=>{
  const amount = parseFloat(document.getElementById("amount").value) || 0;
  const fees = amount * 0.05;
  const net = amount - fees;
  document.getElementById("fees").textContent = fees.toFixed(2);
  document.getElementById("net").textContent = net>0 ? net.toFixed(2) : 0;
});

// Demande de retrait
async function requestWithdraw(){
  const amount = parseFloat(document.getElementById("amount").value);
  const walletAddress = document.getElementById("walletAddress").value.trim();
  const network = document.getElementById("network").value;
  const fees = amount * 0.05;
  const net = amount - fees;

  if(!amount || amount < 3){
    document.getElementById("message").innerHTML = "<span class='error'>‚ö† Montant minimum : 3 USDT</span>";
    return;
  }
  if(!walletAddress){
    document.getElementById("message").innerHTML = "<span class='error'>‚ö† Veuillez saisir une adresse valide</span>";
    return;
  }

  const userDoc = await currentUserDoc.get();
  const data = userDoc.data();
  if(data.balance < amount){
    document.getElementById("message").innerHTML = "<span class='error'>‚ùå Solde insuffisant</span>";
    return;
  }

  await currentUserDoc.update({
    balance: data.balance - amount,
    totalWithdrawn: (data.totalWithdrawn || 0) + amount
  });

  await db.collection("withdrawals").add({
    userId: auth.currentUser.uid,
    username: data.username,
    amount: amount,
    fees: fees,
    net: net,
    wallet: walletAddress,
    network: network,
    status: "pending",
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  document.getElementById("message").innerHTML = "<span class='success'>‚úÖ Retrait demand√© avec succ√®s</span>";
  document.getElementById("balance").textContent = data.balance - amount;
  document.getElementById("withdrawn").textContent = (data.totalWithdrawn || 0) + amount;
}
</script>

</body>
  </html>
    
