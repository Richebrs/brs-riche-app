<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Retrait - BRS RICHE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#f4f7fb; color:#333; display:none; }
header { background:#0d47a1; color:#fff; padding:20px; position:relative; text-align:center; }
header h1 { margin:0; font-size:1.6em; }
.back-btn { position:absolute; left:20px; top:22px; color:#fff; text-decoration:none; font-weight:bold; }

.container { max-width:450px; margin:20px auto; padding:0 15px; }

.card {
  background:#fff; border-radius:16px; padding:20px; margin-bottom:20px;
  box-shadow:0 6px 16px rgba(0,0,0,0.15); text-align:center;
}

.card h3 { margin:0; color:#0d47a1; font-size:1em; }
.card p { font-size:1.4em; font-weight:bold; margin:10px 0 0; }

input, select { width:100%; padding:12px 10px; margin:8px 0 15px; border-radius:8px; border:1px solid #ccc; font-size:1em; }
button { padding:12px; width:100%; font-size:1.2em; font-weight:bold; color:#fff; background:#ff9800; border:none; border-radius:12px; cursor:pointer; transition:0.2s; }
button:hover { background:#e68900; }

.msg { margin:10px 0; font-size:0.95em; }
.msg.success { color:green; }
.msg.error { color:red; }

.history { text-align:center; }
.history-list { list-style:none; padding:0; max-height:300px; overflow-y:auto; margin:10px 0; }
.history-list li { margin:5px 0; padding:10px 15px; border-radius:12px; font-size:0.95em; text-align:center; display:flex; justify-content:space-between; align-items:center; }
.status-Pending { background:#fff3cd; color:#856404; }
.status-Success { background:#d4edda; color:#155724; }
.status-Refus√© { background:#f8d7da; color:#721c24; }
.copy-btn { cursor:pointer; color:#0d47a1; margin-left:5px; }

#see-more { margin-top:10px; display:inline-block; background:#0d47a1; color:#fff; padding:8px 15px; border-radius:12px; cursor:pointer; transition:0.2s; }
#see-more:hover { background:#08306b; }

@media(max-width:480px){
  .card { padding:15px; }
  input, select, button { font-size:1em; padding:10px; }
  .history-list li { flex-direction: column; font-size:0.9em; }
}
</style>
</head>
<body>
<header>
  <h1>üí∏ Retrait</h1>
  <a href="dashboard.html" class="back-btn">‚¨Ö Retour</a>
</header>

<div class="container">
  <div class="card">
    <h3>Solde disponible</h3>
    <p id="balance-available">0 USDT</p>
  </div>
  <div class="card">
    <h3>Gains totaux</h3>
    <p id="balance-total">0 USDT</p>
  </div>
  <div class="card">
    <h3>D√©j√† retir√©</h3>
    <p id="balance-withdrawn">0 USDT</p>
  </div>

  <div class="card">
    <label for="amount">Montant √† retirer (USDT) :</label>
    <input type="number" id="amount" placeholder="Ex: 5" min="3">

    <label for="network">R√©seau :</label>
    <select id="network">
      <option value="TRC20">USDT TRC20</option>
      <option value="BEP20">USDT BEP20</option>
    </select>

    <label for="address">Adresse de retrait :</label>
    <input type="text" id="address" placeholder="Votre adresse USDT">

    <p class="msg" id="fee-text">Frais (5%) : 0 USDT | Net √† recevoir : 0 USDT</p>
    <button id="withdraw-btn">üì§ Demander un retrait</button>
    <p class="msg" id="message"></p>
  </div>

  <div class="card history">
    <h3>Historique des retraits</h3>
    <ul class="history-list" id="history-list"></ul>
    <span id="see-more">Voir plus</span>
  </div>
</div>

<script>
document.body.style.display="block";

const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let balanceAvailable = 0, totalGains = 0, totalWithdrawn = 0;
const balanceEl = document.getElementById("balance-available");
const totalEl = document.getElementById("balance-total");
const withdrawnEl = document.getElementById("balance-withdrawn");
const amountEl = document.getElementById("amount");
const feeTextEl = document.getElementById("fee-text");
const messageEl = document.getElementById("message");
const historyListEl = document.getElementById("history-list");
const seeMoreBtn = document.getElementById("see-more");

let lastVisible = null;
const historyLimit = 5;

// üîπ Auth Listener
auth.onAuthStateChanged(user=>{
  if(!user) return window.location.href="login.html";

  const userRef = db.collection("users").doc(user.uid);

  userRef.onSnapshot(doc=>{
    if(doc.exists){
      const data = doc.data();
      const wallet = data.wallet || {};
      balanceAvailable = wallet.balance ?? 0;
      totalWithdrawn = wallet.totalWithdrawn ?? 0;
      totalGains = wallet.totalGains ?? (balanceAvailable + totalWithdrawn);

      balanceEl.innerText = balanceAvailable.toFixed(2)+" USDT";
      withdrawnEl.innerText = totalWithdrawn.toFixed(2)+" USDT";
      totalEl.innerText = totalGains.toFixed(2)+" USDT";
    }
  });

  loadWithdrawHistory(true);
});

// üîπ Historique
function loadWithdrawHistory(initial=true){
  let query = db.collection("withdrawals")
    .where("userId","==",auth.currentUser.uid)
    .orderBy("createdAt","desc")
    .limit(historyLimit);
  
  if(!initial && lastVisible) query = query.startAfter(lastVisible);

  query.get().then(snapshot=>{
    if(initial) historyListEl.innerHTML="";
    snapshot.forEach(doc=>{
      const tx = doc.data();
      const date = tx.createdAt ? tx.createdAt.toDate().toLocaleString() : "‚Äî";
      const status = tx.status || "Pending";
      const icon = status==="Success"?"‚úÖ":status==="Refus√©"?"‚ùå":"‚è≥";
      const li = document.createElement("li");
      li.className="status-"+status;
      li.innerHTML=`<span>${date} | ${tx.amount} USDT | ${icon}</span>
                      <span>${tx.address} <i class="fa fa-copy copy-btn" onclick="navigator.clipboard.writeText('${tx.address}')"></i></span>`;
      historyListEl.appendChild(li);
    });
    lastVisible = snapshot.docs[snapshot.docs.length-1];
  });
}

seeMoreBtn.addEventListener("click",()=>loadWithdrawHistory(false));

// üîπ Calcul frais
function updateFee(){
  const amt = parseFloat(amountEl.value) || 0;
  if(amt<3){ feeTextEl.innerText="Montant minimum : 3 USDT"; return; }
  if(amt>balanceAvailable){ feeTextEl.innerText="Montant sup√©rieur au solde disponible !"; return; }
  const fee = amt*0.05, net=amt-fee;
  feeTextEl.innerText=`Frais (5%) : ${fee.toFixed(2)} USDT | Net √† recevoir : ${net.toFixed(2)} USDT`;
}
amountEl.addEventListener("input",updateFee);

// üîπ Demande de retrait
document.getElementById("withdraw-btn").addEventListener("click", async()=>{
  messageEl.innerText="";
  const amt = parseFloat(amountEl.value);
  const network = document.getElementById("network").value;
  const address = document.getElementById("address").value.trim();

  if(!amt || amt<3){ messageEl.innerText="‚ùå Le montant minimum est 3 USDT"; messageEl.className="msg error"; return;}
  if(amt>balanceAvailable){ messageEl.innerText="‚ùå Montant sup√©rieur au solde disponible !"; messageEl.className="msg error"; return;}
  if(!address){ messageEl.innerText="‚ùå Veuillez entrer une adresse de retrait valide."; messageEl.className="msg error"; return;}

  const fee = amt*0.05, net=amt-fee;

  try{
    const txRef = db.collection("withdrawals").doc();
    await txRef.set({
      userId: auth.currentUser.uid,
      amount: amt,
      fee: fee,
      netReceived: net,
      network: network,
      address: address,
      status:"Success", // d√©duit imm√©diatement
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Mettre √† jour wallet imm√©diatement
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    await userRef.update({
      "wallet.balance": balanceAvailable - amt,
      "wallet.totalWithdrawn": totalWithdrawn + amt
    });

    messageEl.innerText=`‚úÖ Retrait demand√© et valid√© ! Net : ${net.toFixed(2)} USDT`;
    messageEl.className="msg success";
    amountEl.value=""; updateFee(); loadWithdrawHistory(true);

  }catch(e){
    messageEl.innerText=`‚ùå Erreur : ${e.message}`;
    messageEl.className="msg error"; console.error(e);
  }
});
</script>
</body>
  </html>
  
