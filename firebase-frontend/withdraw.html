<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Retrait - BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body {
  font-family:'Segoe UI',sans-serif;
  margin:0; padding:0;
  background:#f4f7fb; color:#333;
  display:none;
}
header {
  background:#0d47a1; color:#fff; padding:20px; position:relative; text-align:center;
}
header h1 { margin:0; font-size:1.6em; }
.back-btn {
  position:absolute; left:15px; top:20px;
  color:#fff; text-decoration:none; font-weight:bold;
}
.container {
  margin:20px auto; max-width:480px; background:#fff;
  padding:20px; border-radius:16px;
  box-shadow:0 6px 16px rgba(0,0,0,0.15);
}
.balance-box { margin-bottom:15px; }
.balance-box h3 { margin:0; font-size:1em; color:#0d47a1; }
.balance-box p { margin:5px 0 0; font-size:1.4em; font-weight:bold; }

input, select {
  width:100%; padding:12px 10px; margin:8px 0 15px;
  border-radius:8px; border:1px solid #ccc; font-size:1em;
}
button {
  padding:12px; width:100%; font-size:1.1em; font-weight:bold;
  color:#fff; background:#ff9800; border:none; border-radius:12px;
  cursor:pointer; transition:0.2s;
}
button:hover { background:#e68900; }

.msg { margin:10px 0; font-size:0.95em; }
.success { color:green; }
.error { color:red; }

.history { margin-top:30px; }
.history h3 { margin-bottom:10px; color:#0d47a1; text-align:center; }
.history-list {
  list-style:none; padding:0; margin:0;
  max-height:280px; overflow-y:auto;
}
.history-list li {
  margin:6px 0; padding:10px;
  border-radius:8px; font-size:0.95em;
  display:flex; flex-direction:column;
  text-align:left;
}
.status-pending { background:#fff3cd; color:#856404; }
.status-success { background:#d4edda; color:#155724; }
.status-failed  { background:#f8d7da; color:#721c24; }

.copy-btn { cursor:pointer; color:#0d47a1; margin-left:5px; }
@media(max-width:600px){
  .container { margin:10px; padding:15px; }
  header h1 { font-size:1.3em; }
}
</style>
</head>
<body>
<header>
  <h1>üí∏ Demande de Retrait</h1>
  <a href="dashboard.html" class="back-btn">‚¨Ö Retour</a>
</header>

<div class="container">
  <div class="balance-box"><h3>Solde disponible</h3><p id="balance-available">0 USDT</p></div>
  <div class="balance-box"><h3>Gains totaux</h3><p id="balance-total">0 USDT</p></div>
  <div class="balance-box"><h3>D√©j√† retir√©</h3><p id="balance-withdrawn">0 USDT</p></div>

  <label for="amount">Montant √† retirer (USDT) :</label>
  <input type="number" id="amount" placeholder="Ex: 5" min="3">

  <label for="network">R√©seau :</label>
  <select id="network">
    <option value="TRC20">USDT TRC20</option>
    <option value="BEP20">USDT BEP20</option>
  </select>

  <label for="address">Adresse de retrait :</label>
  <input type="text" id="address" placeholder="Votre adresse USDT">
  <span class="copy-btn" id="copy-address"><i class="fa fa-copy"></i> Copier</span>

  <p class="msg" id="fee-text">Frais (5%) : 0 USDT | Net √† recevoir : 0 USDT</p>
  <button id="withdraw-btn">üì§ Demander un retrait</button>
  <p class="msg" id="message"></p>

  <div class="history">
    <h3>Historique des retraits</h3>
    <ul class="history-list" id="history-list"></ul>
  </div>
</div>

<script>
document.body.style.display = "block";

const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

let balanceAvailable = 0;
let totalGains = 0;
let totalWithdrawn = 0;

const balanceEl = document.getElementById("balance-available");
const totalEl = document.getElementById("balance-total");
const withdrawnEl = document.getElementById("balance-withdrawn");
const amountEl = document.getElementById("amount");
const feeTextEl = document.getElementById("fee-text");
const messageEl = document.getElementById("message");
const historyListEl = document.getElementById("history-list");
const copyBtn = document.getElementById("copy-address");
const addressEl = document.getElementById("address");

auth.onAuthStateChanged(user => {
  if (!user) return window.location.href = "login.html";
  const userRef = db.collection("users").doc(user.uid);

  // üîπ Solde en temps r√©el
  userRef.onSnapshot(doc => {
    if (doc.exists) {
      const data = doc.data();
      const wallet = data.wallet || {};
      balanceAvailable = wallet.balance ?? 0;
      totalWithdrawn = wallet.totalWithdrawn ?? 0;
      totalGains = wallet.totalGains ?? (balanceAvailable + totalWithdrawn);

      balanceEl.innerText = `${balanceAvailable.toFixed(2)} USDT`;
      withdrawnEl.innerText = `${totalWithdrawn.toFixed(2)} USDT`;
      totalEl.innerText = `${totalGains.toFixed(2)} USDT`;
    }
  });

  // üîπ Historique
  db.collection("withdrawals")
    .where("userId","==",user.uid)
    .orderBy("createdAt","desc")
    .limit(10)
    .onSnapshot(snapshot => {
      historyListEl.innerHTML = "";
      snapshot.forEach(doc => {
        const tx = doc.data();
        const status = tx.status || "Pending";
        let statusClass = status === "Pending" ? "status-pending" :
                          status === "Success" ? "status-success" :
                          "status-failed";
        const date = tx.createdAt ? tx.createdAt.toDate().toLocaleString() : "‚Äî";
        historyListEl.innerHTML += `
          <li class="${statusClass}">
            <strong>${date}</strong><br>
            Montant: ${tx.amount} USDT | Net: ${tx.netReceived} USDT <br>
            Adresse: ${tx.address}
            <span class="copy-btn" onclick="navigator.clipboard.writeText('${tx.address}')">
              <i class="fa fa-copy"></i>
            </span>
            <br>Statut: ${status}
          </li>`;
      });
    });
});

// üîπ Calcul frais
function updateFee(){
  const amt = parseFloat(amountEl.value) || 0;
  if(amt < 3){ feeTextEl.innerText = "Montant minimum : 3 USDT"; return; }
  if(amt > balanceAvailable){ feeTextEl.innerText = "Montant sup√©rieur au solde disponible !"; return; }
  const fee = amt * 0.05;
  const net = amt - fee;
  feeTextEl.innerText = `Frais (5%) : ${fee.toFixed(2)} USDT | Net √† recevoir : ${net.toFixed(2)} USDT`;
}
amountEl.addEventListener("input", updateFee);

// üîπ Copier adresse
copyBtn.addEventListener("click", () => {
  const val = addressEl.value.trim();
  if(val) navigator.clipboard.writeText(val).then(() => alert("Adresse copi√©e !"));
});

// üîπ Retrait
document.getElementById("withdraw-btn").addEventListener("click", async () => {
  messageEl.innerText = "";
  const amt = parseFloat(amountEl.value);
  const network = document.getElementById("network").value;
  const address = addressEl.value.trim();

  if(!amt || amt < 3){ messageEl.innerText="‚ùå Montant minimum 3 USDT"; messageEl.className="msg error"; return; }
  if(amt > balanceAvailable){ messageEl.innerText="‚ùå Montant sup√©rieur au solde disponible !"; messageEl.className="msg error"; return; }
  if(!address){ messageEl.innerText="‚ùå Adresse invalide"; messageEl.className="msg error"; return; }

  const fee = amt*0.05;
  const net = amt-fee;

  try{
    const txRef = db.collection("withdrawals").doc();
    await txRef.set({
      userId: auth.currentUser.uid,
      amount: amt,
      fee: fee,
      netReceived: net,
      network: network,
      address: address,
      status: "Pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // üîπ Mise √† jour imm√©diate du solde
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    await userRef.update({
      "wallet.balance": balanceAvailable-amt,
      "wallet.totalWithdrawn": totalWithdrawn+amt
    });

    messageEl.innerText = `‚úÖ Retrait demand√© ! Net : ${net.toFixed(2)} USDT`;
    messageEl.className = "msg success";

    amountEl.value=""; updateFee();
  }catch(e){
    messageEl.innerText=`‚ùå Erreur : ${e.message}`;
    messageEl.className="msg error";
    console.error(e);
  }
});
</script>
</body>
</html>
