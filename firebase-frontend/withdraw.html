<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Retrait | BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:20px; background:#f4f6f8; }
  h2 { text-align:center; color:#1976d2; margin-bottom:20px; }
  .card { background:white; padding:20px; border-radius:10px; box-shadow:0 2px 8px rgba(0,0,0,0.1); max-width:400px; margin:0 auto; }
  label { display:block; margin-top:12px; font-weight:bold; }
  input, select { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:5px; }
  button { margin-top:20px; width:100%; padding:12px; background:#1976d2; color:white; border:none; border-radius:5px; cursor:pointer; font-size:16px; }
  button:hover { background:#0d47a1; }
  .info { margin-top:10px; color:#555; font-size:14px; }
  .success { color:green; font-weight:bold; margin-top:15px; }
  .error { color:red; font-weight:bold; margin-top:15px; }
  .balance { text-align:center; font-size:18px; margin-bottom:15px; color:#2e7d32; }
  .back-btn { display:block; text-align:center; margin-top:20px; padding:10px; background:#ccc; border-radius:5px; text-decoration:none; color:black; }
</style>
</head>
<body>

<h2>üí∏ Demande de Retrait</h2>

<div class="card">
  <div id="balanceDisplay" class="balance">Chargement du solde...</div>

  <label for="amount">Montant √† retirer (USDT) :</label>
  <input type="number" id="amount" min="3" placeholder="Ex: 30">

  <div class="info" id="feeInfo">Frais : 1 USDT + 5%</div>

  <label for="network">R√©seau :</label>
  <select id="network">
    <option value="TRC20">TRC20</option>
    <option value="BEP20">BEP20</option>
  </select>

  <label for="address">Adresse de retrait :</label>
  <input type="text" id="address" placeholder="Ex: TX8z...">

  <button onclick="requestWithdraw()">üì§ Demander un retrait</button>

  <div id="message"></div>

  <a href="dashboard.html" class="back-btn">‚¨Ö Retourner</a>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let currentUser, currentBalance = 0;

// üîπ Afficher solde disponible
auth.onAuthStateChanged(async (user)=>{
  if(user){
    currentUser = user;
    const userDoc = await db.collection("users").doc(user.uid).get();
    if(userDoc.exists){
      const data = userDoc.data();
      currentBalance = data.balance || data.totalGains || 0;
      document.getElementById("balanceDisplay").innerText = 
        "üí∞ Solde disponible : " + currentBalance + " USDT";
    } else {
      document.getElementById("balanceDisplay").innerText = "‚ö†Ô∏è Profil introuvable";
    }
  } else {
    window.location.href = "login.html"; 
  }
});

// üîπ Calcul frais en temps r√©el
document.getElementById("amount").addEventListener("input", ()=>{
  const amount = parseFloat(document.getElementById("amount").value) || 0;
  const fee = 1 + (amount * 0.05);
  document.getElementById("feeInfo").innerText = 
    `Frais appliqu√©s : 1 USDT + 5% = ${fee.toFixed(2)} USDT`;
});

// üîπ Demande de retrait
async function requestWithdraw(){
  const amount = parseFloat(document.getElementById("amount").value);
  const network = document.getElementById("network").value;
  const address = document.getElementById("address").value;
  const msgBox = document.getElementById("message");

  if(!amount || amount < 3){
    msgBox.innerHTML = "<p class='error'>‚ùå Le montant minimum de retrait est 3 USDT.</p>";
    return;
  }

  const fee = 1 + (amount * 0.05);
  const totalDebit = amount;
  const received = amount - fee;

  if(amount > currentBalance){
    msgBox.innerHTML = `<p class='error'>‚ùå Solde insuffisant. Votre solde est de ${currentBalance} USDT.</p>`;
    return;
  }

  if(address.trim() === ""){
    msgBox.innerHTML = "<p class='error'>‚ùå Veuillez entrer une adresse de retrait.</p>";
    return;
  }

  try {
    await db.collection("withdrawals").add({
      userId: currentUser.uid,
      email: currentUser.email,
      amount: amount,
      fee: fee,
      received: received,
      network: network,
      address: address,
      status: "En attente",
      createdAt: new Date()
    });

    // D√©duire automatiquement du solde
    await db.collection("users").doc(currentUser.uid).update({
      balance: currentBalance - amount,
      totalWithdrawn: firebase.firestore.FieldValue.increment(amount)
    });

    msgBox.innerHTML = `<p class='success'>‚úÖ Votre demande de retrait de ${amount} USDT est envoy√©e. Vous recevrez environ ${received.toFixed(2)} USDT apr√®s frais.</p>`;
    document.getElementById("amount").value = "";
    document.getElementById("address").value = "";
    document.getElementById("feeInfo").innerText = "Frais : 1 USDT + 5%";
    document.getElementById("balanceDisplay").innerText = 
      "üí∞ Solde disponible : " + (currentBalance - amount) + " USDT";

  } catch (err){
    console.error(err);
    msgBox.innerHTML = "<p class='error'>‚ùå Erreur lors de la demande. R√©essayez.</p>";
  }
}
</script>
</body>
      </html>
  
