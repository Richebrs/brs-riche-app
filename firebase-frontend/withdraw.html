
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Demande de Retrait - BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body{font-family:'Segoe UI',sans-serif;background:#f4f7fb;margin:0;padding:0;display:none}
header{background:#0d47a1;color:#fff;padding:20px;text-align:center;position:relative}
.back-btn{position:absolute;left:15px;top:20px;color:#fff;text-decoration:none;font-weight:bold}
.container{max-width:450px;margin:30px auto;background:#fff;padding:25px;border-radius:16px;box-shadow:0 6px 16px rgba(0,0,0,0.1);text-align:center}
h3{color:#0d47a1;font-weight:600}
.balance-box{margin-bottom:20px}
.balance-box p{font-size:1.3em;font-weight:bold;color:#222}
input,select{width:100%;padding:12px;margin:10px 0;border-radius:10px;border:1px solid #ccc;font-size:1em}
button{width:100%;padding:12px;background:#ff9800;color:#fff;font-size:1.1em;border:none;border-radius:12px;cursor:pointer;transition:background .2s}
button:hover{background:#e68900}
.msg{font-size:.95em;margin-top:10px}
.success{color:green}.error{color:red}
.history{margin-top:30px}
.history h3{color:#0d47a1}
.history-list{list-style:none;padding:0;margin:10px 0;text-align:center}
.history-list li{background:#f5f7fb;border-radius:10px;padding:10px;margin-bottom:10px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.status-pending{color:#b07a00;font-weight:600}
.status-success{color:#0c880c;font-weight:600}
.status-failed{color:#d93025;font-weight:600}
.loading{opacity:.6;pointer-events:none}
</style>
</head>
<body>
<header>
  <h1>üí∏ Demande de Retrait</h1>
  <a href="dashboard.html" class="back-btn">‚¨Ö Retour</a>
</header>
<div class="container">
  <div class="balance-box">
    <h3>Solde disponible</h3>
    <p id="balance-available">0 USDT</p>
  </div>
  <input type="number" id="amount" placeholder="Montant √† retirer (min 3 USDT)" min="3">
  <select id="network">
    <option value="TRC20">USDT TRC20</option>
    <option value="BEP20">USDT BEP20</option>
  </select>
  <input type="text" id="address" placeholder="Adresse USDT">
  <p class="msg" id="fee-text">Frais (5%) : 0 USDT | Net √† recevoir : 0 USDT</p>
  <button id="withdraw-btn">üì§ Demander un retrait</button>
  <p class="msg" id="message"></p>
  <div class="history">
    <h3>Historique des retraits</h3>
    <ul class="history-list" id="history-list"></ul>
  </div>
</div>
<script>
document.body.style.display="block";
const firebaseConfig={apiKey:"AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",authDomain:"brs-riche-2.firebaseapp.com",projectId:"brs-riche-2"};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(),db=firebase.firestore();
let balanceAvailable=0,totalWithdrawn=0;
const b=document.getElementById("balance-available"),a=document.getElementById("amount"),f=document.getElementById("fee-text"),m=document.getElementById("message"),h=document.getElementById("history-list"),btn=document.getElementById("withdraw-btn");
auth.onAuthStateChanged(u=>{
 if(!u)return location.href="login.html";
 const ref=db.collection("users").doc(u.uid);
 ref.onSnapshot(d=>{
  if(d.exists){
   const w=d.data().wallet||{};
   balanceAvailable=w.balance??0;
   totalWithdrawn=w.totalWithdrawn??0;
   b.innerText=`${balanceAvailable.toFixed(2)} USDT`;
  }
 });
 db.collection("withdrawals").where("userId","==",u.uid).orderBy("createdAt","desc").onSnapshot(s=>{
  h.innerHTML="";
  s.forEach(doc=>{
   const x=doc.data(),status=x.status||"Pending",cls=status=="Pending"?"status-pending":status=="Success"?"status-success":"status-failed";
   const date=x.createdAt?x.createdAt.toDate().toLocaleString():"‚Äî";
   h.innerHTML+=`<li><div><strong>Date :</strong> ${date}</div><div><strong>Montant :</strong> ${x.amount} USDT</div><div><strong>Statut :</strong> <span class="${cls}">${status}</span></div></li>`;
  });
 });
});
a.addEventListener("input",()=>{
 const v=parseFloat(a.value)||0;
 if(v<3){f.innerText="Montant minimum : 3 USDT";return}
 if(v>balanceAvailable){f.innerText="Montant sup√©rieur au solde disponible !";return}
 const fee=v*0.05,net=v-fee;
 f.innerText=`Frais (5%) : ${fee.toFixed(2)} USDT | Net √† recevoir : ${net.toFixed(2)} USDT`;
});
btn.addEventListener("click",async()=>{
 m.innerText="";
 const v=parseFloat(a.value),n=document.getElementById("network").value,ad=document.getElementById("address").value.trim();
 if(!v||v<3){m.innerText="‚ùå Montant minimum 3 USDT";m.className="msg error";return}
 if(v>balanceAvailable){m.innerText="‚ùå Montant sup√©rieur au solde disponible !";m.className="msg error";return}
 if(!ad){m.innerText="‚ùå Adresse invalide";m.className="msg error";return}
 const fee=v*0.05,net=v-fee;
 btn.classList.add("loading");btn.innerText="‚è≥ Envoi en cours...";
 try{
  const ref=db.collection("users").doc(auth.currentUser.uid);
  await db.collection("withdrawals").add({
   userId:auth.currentUser.uid,
   amount:v,
   fee:fee,
   netReceived:net,
   network:n,
   address:ad,
   status:"Pending",
   createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  await ref.update({
   "wallet.balance":balanceAvailable-v,
   "wallet.totalWithdrawn":totalWithdrawn+v
  });
  m.innerText="‚úÖ Demande envoy√©e, en attente de validation admin.";
  m.className="msg success";
  a.value="";f.innerText="Frais (5%) : 0 USDT | Net √† recevoir : 0 USDT";
 }catch(e){
  m.innerText="‚ùå Erreur : "+e.message;
  m.className="msg error";
 }finally{
  btn.classList.remove("loading");
  btn.innerText="üì§ Demander un retrait";
 }
});
</script>
</body>
</html>

  
