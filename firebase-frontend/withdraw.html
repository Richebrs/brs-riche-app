<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BRS Riche - Retrait</title>
<style>
  body { font-family: Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
  .card { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); max-width: 400px; width: 100%; }
  h2 { text-align: center; color: #333; margin-bottom: 20px; }
  label { display: block; margin-top: 10px; color: #555; font-weight: bold; }
  input, select, button { width: 100%; padding: 10px; margin-top: 5px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; }
  button { background: #4caf50; color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s; }
  button:hover { background: #45a049; }
  .info { margin: 10px 0; font-weight: bold; color: #333; }
  .success { color: green; font-weight: bold; margin-top: 10px; text-align: center; }
  .error { color: red; font-weight: bold; margin-top: 10px; text-align: center; }
  .help { color: #888; font-size: 14px; margin-top: 5px; }
</style>
</head>
<body>

<div class="card">
  <h2>üí∏ Demande de Retrait</h2>

  <div class="info">üí∞ Solde disponible : <span id="balance">0</span> USDT</div>
  <div class="info">üìà Gains totaux : <span id="gains">0</span> USDT</div>
  <div class="info">üè¶ D√©j√† retir√© : <span id="withdrawn">0</span> USDT</div>

  <label>Montant √† retirer (USDT) :</label>
  <input type="number" id="amount" min="3" placeholder="Ex: 5">
  <div class="help">Minimum de retrait : 3 USDT</div>

  <div class="info">Frais (5%) : <span id="fees">0</span> USDT</div>
  <div class="info">Net √† recevoir : <span id="net">0</span> USDT</div>

  <label>R√©seau :</label>
  <select id="network">
    <option value="TRC20">USDT TRC20</option>
    <option value="BEP20">USDT BEP20</option>
  </select>

  <label>Adresse de retrait :</label>
  <input type="text" id="walletAddress" placeholder="Votre adresse USDT">
  <div class="help">Ex: TXXXX ou BSC address selon le r√©seau choisi</div>

  <button onclick="requestWithdraw()">üì§ Demander un retrait</button>
  <p id="message"></p>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  // Config Firebase (BRS-Riche-2)
  const firebaseConfig = {
    apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
    authDomain: "brs-riche-2.firebaseapp.com",
    projectId: "brs-riche-2",
    storageBucket: "brs-riche-2.appspot.com",
    messagingSenderId: "313874599780",
    appId: "1:313874599780:web:xxxxxx"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentUserDoc;

  // R√©cup√©ration utilisateur connect√©
  auth.onAuthStateChanged(async (user) => {
    if (user) {
      try {
        const docRef = db.collection("users").doc(user.uid);
        const docSnap = await docRef.get();
        if (docSnap.exists) {
          currentUserDoc = docRef;
          const data = docSnap.data();
          const balance = Number(data.balance) || 0;
          const totalGains = Number(data.totalGains) || 0;
          const totalWithdrawn = Number(data.totalWithdrawn) || 0;

          document.getElementById("balance").textContent = balance.toFixed(2);
          document.getElementById("gains").textContent = totalGains.toFixed(2);
          document.getElementById("withdrawn").textContent = totalWithdrawn.toFixed(2);
        } else {
          document.getElementById("message").innerHTML = "<span class='error'>‚ö† Utilisateur introuvable</span>";
        }
      } catch (err) {
        console.error(err);
        document.getElementById("message").innerHTML = "<span class='error'>‚ö† Erreur lors de la r√©cup√©ration des donn√©es</span>";
      }
    } else {
      document.getElementById("message").innerHTML = "<span class='error'>‚ö† Veuillez vous connecter</span>";
    }
  });

  // Calcul frais et net
  document.getElementById("amount").addEventListener("input", () => {
    const amount = parseFloat(document.getElementById("amount").value) || 0;
    const fees = amount * 0.05;
    const net = amount - fees;
    document.getElementById("fees").textContent = fees.toFixed(2);
    document.getElementById("net").textContent = net > 0 ? net.toFixed(2) : 0;
  });

  // Demande de retrait
  async function requestWithdraw() {
    const amount = parseFloat(document.getElementById("amount").value);
    const walletAddress = document.getElementById("walletAddress").value.trim();
    const network = document.getElementById("network").value;
    const fees = amount * 0.05;
    const net = amount - fees;

    if (!amount || amount < 3) {
      document.getElementById("message").innerHTML = "<span class='error'>‚ö† Montant minimum : 3 USDT</span>";
      return;
    }
    if (!walletAddress) {
      document.getElementById("message").innerHTML = "<span class='error'>‚ö† Veuillez saisir une adresse de retrait</span>";
      return;
    }

    const docSnap = await currentUserDoc.get();
    const data = docSnap.data();
    if (data.balance < amount) {
      document.getElementById("message").innerHTML = "<span class='error'>‚ùå Solde insuffisant</span>";
      return;
    }

    // D√©duire le solde et enregistrer le retrait
    await currentUserDoc.update({
      balance: data.balance - amount,
      totalWithdrawn: (data.totalWithdrawn || 0) + amount
    });

    await db.collection("withdrawals").add({
      userId: auth.currentUser.uid,
      username: data.username,
      amount: amount,
      fees: fees,
      net: net,
      wallet: walletAddress,
      network: network,
      status: "pending",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    document.getElementById("message").innerHTML = "<span class='success'>‚úÖ Retrait demand√© avec succ√®s</span>";
    document.getElementById("balance").textContent = (data.balance - amount).toFixed(2);
    document.getElementById("withdrawn").textContent = ((data.totalWithdrawn || 0) + amount).toFixed(2);
  }
</script>
</body>
  </html>
  
