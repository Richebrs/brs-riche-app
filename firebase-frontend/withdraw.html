<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Retrait - BRS Riche</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h2 { color: #333; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 6px; }
    button { background: #28a745; color: white; border: none; padding: 12px; width: 100%; margin-top: 15px; border-radius: 8px; font-size: 16px; cursor: pointer; }
    button:hover { background: #218838; }
    .back-btn { display: block; text-align: center; margin-top: 15px; color: #007bff; text-decoration: none; }
    .back-btn:hover { text-decoration: underline; }
    .info { margin-top: 10px; font-size: 14px; color: #555; }
    .error { color: red; margin-top: 10px; }
    .success { color: green; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="card">
    <h2>üí∏ Demande de Retrait</h2>
    <p><strong>üí∞ Solde disponible :</strong> <span id="availableBalance">Chargement...</span></p>

    <label>Montant √† retirer (USDT) :</label>
    <input type="number" id="withdrawAmount" placeholder="Entrez le montant">

    <p class="info">üìå Frais : 1 USDT + 5% du montant</p>
    <p><strong>Net √† recevoir :</strong> <span id="netReceive">0</span> USDT</p>

    <label>R√©seau :</label>
    <select id="network">
      <option value="TRC20">TRC20</option>
      <option value="BEP20">BEP20</option>
    </select>

    <label>Adresse de retrait :</label>
    <input type="text" id="withdrawAddress" placeholder="Entrez l'adresse de votre portefeuille">

    <button onclick="requestWithdraw()">üì§ Demander un retrait</button>
    <p id="message"></p>
    <a href="dashboard.html" class="back-btn">‚¨Ö Retourner</a>
  </div>

  <script>
    // ‚úÖ Configuration Firebase (√† remplacer par la tienne)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    let availableBalance = 0;

    // ‚úÖ R√©cup√©rer solde utilisateur
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const doc = await db.collection("users").doc(user.uid).get();
        if (doc.exists) {
          const data = doc.data();
          availableBalance = data.wallet?.balance || data.totalGains || 0;
          document.getElementById("availableBalance").textContent = availableBalance + " USDT";
        }
      } else {
        window.location.href = "login.html";
      }
    });

    // ‚úÖ Calculer net √† recevoir
    document.getElementById("withdrawAmount").addEventListener("input", function() {
      const amount = parseFloat(this.value) || 0;
      const fees = 1 + (amount * 0.05);
      const net = amount - fees;
      document.getElementById("netReceive").textContent = net > 0 ? net.toFixed(2) : 0;
    });

    // ‚úÖ Demande de retrait
    async function requestWithdraw() {
      const amount = parseFloat(document.getElementById("withdrawAmount").value);
      const address = document.getElementById("withdrawAddress").value;
      const network = document.getElementById("network").value;
      const messageEl = document.getElementById("message");

      if (!amount || amount < 3) {
        messageEl.textContent = "‚ùå Le minimum de retrait est 3 USDT.";
        messageEl.className = "error";
        return;
      }

      const fees = 1 + (amount * 0.05);
      const net = amount - fees;

      if (amount > availableBalance) {
        messageEl.textContent = "‚ùå Solde insuffisant. Votre solde est de " + availableBalance + " USDT.";
        messageEl.className = "error";
        return;
      }

      if (!address) {
        messageEl.textContent = "‚ùå Veuillez entrer une adresse de retrait.";
        messageEl.className = "error";
        return;
      }

      const user = auth.currentUser;
      if (!user) return;

      // ‚úÖ Enregistrer le retrait
      await db.collection("withdrawals").add({
        userId: user.uid,
        amount: amount,
        fees: fees,
        net: net,
        network: network,
        address: address,
        status: "En attente",
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });

      // ‚úÖ D√©duire le solde dans Firestore
      await db.collection("users").doc(user.uid).update({
        "wallet.balance": availableBalance - amount,
        totalWithdrawn: firebase.firestore.FieldValue.increment(amount)
      });

      messageEl.textContent = "‚úÖ Retrait demand√© avec succ√®s ! Vous recevrez " + net.toFixed(2) + " USDT.";
      messageEl.className = "success";

      document.getElementById("withdrawAmount").value = "";
      document.getElementById("withdrawAddress").value = "";
      document.getElementById("netReceive").textContent = "0";
      availableBalance -= amount;
      document.getElementById("availableBalance").textContent = availableBalance + " USDT";
    }
  </script>
</body>
                                                                                    </html>
      
