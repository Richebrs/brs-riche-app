<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Dashboard VIP Moderne - Utilisateurs Admis</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f6f8; }
  h1 { color: #2c3e50; }
  input { padding: 8px; width: 300px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background: #fff; }
  th, td { border: 1px solid #ddd; padding: 12px; text-align: left; cursor: pointer; }
  th { background-color: #3498db; color: #fff; }
  tr:nth-child(even) { background-color: #f9f9f9; }
  tr:hover { background-color: #d1ecf1; }
  .vip { font-weight: bold; color: #e74c3c; }
  .badge { padding: 3px 7px; border-radius: 4px; font-size: 0.85em; margin-left: 5px; color: #fff; }
  .solde-eleve { background-color: #27ae60; } 
  .top-gains { background-color: #e67e22; }  
  button { padding: 5px 10px; margin-right: 5px; border-radius: 4px; border: none; cursor: pointer; }
  .edit-btn { background-color: #2980b9; color: #fff; }
  .delete-btn { background-color: #c0392b; color: #fff; }
  /* Modal */
  .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4); }
  .modal-content { background-color: #fff; margin: 10% auto; padding: 20px; border-radius: 6px; width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
  .modal-content input { width: 100%; margin-bottom: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
  .modal-header { font-size: 1.2em; margin-bottom: 10px; }
  .close { float: right; font-size: 1.2em; cursor: pointer; }
  .save-btn { background-color: #27ae60; color: #fff; width: 100%; padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 1em; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getFirestore, collection, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:TON_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let allUsers = [];
let currentSort = { column: null, asc: true };
let editDocId = null;

// Load users
async function loadUsers(filter="") {
  const usersCol = collection(db, "users");
  const usersSnapshot = await getDocs(usersCol);
  allUsers = [];

  usersSnapshot.forEach(docSnap => {
    const data = docSnap.data();
    if (data.role !== "Admis") return;
    if (filter && !data.email.toLowerCase().includes(filter.toLowerCase()) && !data.username.toLowerCase().includes(filter.toLowerCase())) return;
    allUsers.push({ id: docSnap.id, ...data });
  });

  if (currentSort.column) {
    allUsers.sort((a,b) => {
      let valA = currentSort.column.includes('.') ? getNested(a, currentSort.column) : a[currentSort.column];
      let valB = currentSort.column.includes('.') ? getNested(b, currentSort.column) : b[currentSort.column];
      if(valA < valB) return currentSort.asc ? -1 : 1;
      if(valA > valB) return currentSort.asc ? 1 : -1;
      return 0;
    });
  }

  renderTable();
}

function getNested(obj, path) {
  return path.split('.').reduce((o, p) => o ? o[p] : null, obj);
}

function renderTable() {
  const tbody = document.getElementById("usersBody");
  tbody.innerHTML = "";
  allUsers.forEach(user => {
    const soldeBadge = user.wallet?.balance > 1000 ? `<span class="badge solde-eleve">üí∞ Solde √©lev√©</span>` : '';
    const gainsBadge = user.totalGains > 5000 ? `<span class="badge top-gains">üèÜ Top Gains</span>` : '';
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="vip">${user.email}</td>
      <td>${user.username}</td>
      <td>${user.wallet?.balance || 0} ${soldeBadge}</td>
      <td>${user.totalGains || 0} ${gainsBadge}</td>
      <td>${user.totalWithdrawn || 0}</td>
      <td>
        <button class="edit-btn" onclick="openEditModal('${user.id}')">Modifier</button>
        <button class="delete-btn" onclick="deleteUser('${user.id}')">Supprimer</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

// Search
function searchUsers() {
  const filter = document.getElementById("searchInput").value;
  loadUsers(filter);
}

// Sort
function sortTable(column) {
  if (currentSort.column === column) currentSort.asc = !currentSort.asc;
  else { currentSort.column = column; currentSort.asc = true; }
  loadUsers(document.getElementById("searchInput").value);
}

// Edit Modal
function openEditModal(docId) {
  editDocId = docId;
  const user = allUsers.find(u => u.id === docId);
  if (!user) return;
  document.getElementById("editUsername").value = user.username;
  document.getElementById("editBalance").value = user.wallet?.balance || 0;
  document.getElementById("editGains").value = user.totalGains || 0;
  document.getElementById("editWithdrawn").value = user.totalWithdrawn || 0;
  document.getElementById("editModal").style.display = "block";
}

async function saveEdit() {
  const username = document.getElementById("editUsername").value;
  const balance = parseFloat(document.getElementById("editBalance").value);
  const gains = parseFloat(document.getElementById("editGains").value);
  const withdrawn = parseFloat(document.getElementById("editWithdrawn").value);

  if(username && !isNaN(balance) && !isNaN(gains) && !isNaN(withdrawn)) {
    await updateDoc(doc(db,"users",editDocId),{
      username: username,
      "wallet.balance": balance,
      totalGains: gains,
      totalWithdrawn: withdrawn
    });
    closeModal();
    loadUsers(document.getElementById("searchInput").value);
  } else {
    alert("Veuillez remplir correctement tous les champs.");
  }
}

function closeModal() {
  document.getElementById("editModal").style.display = "none";
}

// Delete user
async function deleteUser(docId) {
  if(confirm("Voulez-vous vraiment supprimer cet utilisateur ?")) {
    await deleteDoc(doc(db,"users",docId));
    loadUsers(document.getElementById("searchInput").value);
  }
}

window.onload = () => loadUsers();
</script>
</head>
<body>
<h1>Dashboard VIP Moderne - Utilisateurs Admis</h1>
<input type="text" id="searchInput" placeholder="Rechercher par email ou username" oninput="searchUsers()" />

<table>
  <thead>
    <tr>
      <th onclick="sortTable('email')">Email</th>
      <th onclick="sortTable('username')">Username</th>
      <th onclick="sortTable('wallet.balance')">Solde</th>
      <th onclick="sortTable('totalGains')">Total Gains</th>
      <th onclick="sortTable('totalWithdrawn')">Total Retraits</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="usersBody"></tbody>
</table>

<!-- Edit Modal -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div class="modal-header">Modifier Utilisateur</div>
    <input type="text" id="editUsername" placeholder="Username" />
    <input type="number" id="editBalance" placeholder="Solde" />
    <input type="number" id="editGains" placeholder="Total Gains" />
    <input type="number" id="editWithdrawn" placeholder="Total Retraits" />
    <button class="save-btn" onclick="saveEdit()">Sauvegarder</button>
  </div>
</div>
</body>
  </html>
  
