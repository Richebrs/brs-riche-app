<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Historique - BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body {font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4;}
header {background:#222; color:#fff; padding:12px 16px; display:flex; align-items:center; justify-content:center; position:relative;}
header h1 {margin:0; font-size:18px; text-align:center;}
.back-btn {position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#fff; text-decoration:none; font-weight:600;}
.container {padding:20px; max-width:480px; margin:0 auto;}
.activity {background:#fff; margin-bottom:12px; padding:14px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
.activity strong {display:block; margin-bottom:4px;}
.date {color:gray; font-size:13px;}
.status-ok {color:#2e7d32; font-weight:700;}
.status-pending {color:#b8860b; font-weight:700;}
.status-refused {color:#e53935; font-weight:700;}
#load-more {display:block; margin:16px auto; padding:10px 14px; background:#0d47a1; color:#fff; border:none; border-radius:6px; cursor:pointer;}
.no-data {text-align:center; color:#777; padding:12px;}
</style>
</head>
<body>

<header>
  <a href="dashboard.html" class="back-btn">‚Üê Retour</a>
  <h1>üìú Historique des d√©p√¥ts</h1>
</header>

<div class="container" id="activity-list">
  <p class="no-data">Chargement...</p>
</div>
<button id="load-more" style="display:none;">Voir plus</button>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const activityList = document.getElementById("activity-list");
const loadMoreBtn = document.getElementById("load-more");
let currentUserId = null;
let lastVisible = null;
let limit = 10;

// render
function renderActivities(docs, append=false){
  if(!append) activityList.innerHTML = '';
  if(docs.length===0 && !append){
    activityList.innerHTML = '<p class="no-data">Aucun d√©p√¥t trouv√©.</p>';
    loadMoreBtn.style.display='none';
    return;
  }
  docs.forEach(doc=>{
    const data = doc.data();
    const div = document.createElement('div');
    div.className='activity';
    const status = (data.status||'').toLowerCase();
    const statusClass = status.includes('valid√©')?'status-ok':status.includes('refus√©')?'status-refused':'status-pending';
    const created = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : '';
    div.innerHTML=`
      <strong>Montant : $${data.amount} | R√©seau : ${data.network}</strong>
      <span>Hash/ID : ${data.txHash||'-'}</span><br>
      <span>Email : ${data.email||'-'}</span><br>
      <span class="${statusClass}">Status : ${data.status}</span><br>
      <span class="date">${created}</span>
    `;
    activityList.appendChild(div);
  });
}

// fetch
function loadDeposits(append=false){
  if(!currentUserId) return;
  let query = db.collection('deposits').where('userId','==',currentUserId).orderBy('createdAt','desc').limit(limit);
  if(lastVisible && append) query = query.startAfter(lastVisible);
  query.get().then(snapshot=>{
    if(!snapshot.empty) lastVisible = snapshot.docs[snapshot.docs.length-1];
    renderActivities(snapshot.docs, append);
    loadMoreBtn.style.display = snapshot.size < limit ? 'none' : 'block';
  }).catch(console.error);
}

loadMoreBtn.addEventListener('click', ()=>{ loadDeposits(true); });

// auth
auth.onAuthStateChanged(user=>{
  if(!user){ window.location.href='login.html'; return; }
  currentUserId = user.uid;
  loadDeposits();
});
</script>

</body>
  </html>
  
