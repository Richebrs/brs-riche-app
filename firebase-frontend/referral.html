<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Parrainage - BRS RICHE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
body {
  font-family: 'Segoe UI', Arial, sans-serif;
  margin:0; padding:0;
  background: linear-gradient(135deg,#0d47a1,#1976d2);
  display: flex; justify-content: center; align-items: center; min-height: 100vh;
  color:#333;
}
#referral-container {
  background:#fff; padding:30px 24px; border-radius:20px; max-width:500px; width:95%;
  text-align:center; box-shadow:0 8px 28px rgba(0,0,0,0.25);
}
h1 { color:#0d47a1; margin-bottom:20px; font-size:2em; }
p { margin:10px 0; }
.link-box { background:#f4f7fb; padding:10px; border-radius:10px; display:flex; justify-content:center; align-items:center; word-break:break-all; margin:10px 0; }
.copy-btn { cursor:pointer; margin-left:10px; color:#0d47a1; }
.table { width:100%; margin-top:20px; border-collapse:collapse; }
.table th, .table td { border:1px solid #ccc; padding:8px; text-align:center; }
.table th { background:#0d47a1; color:#fff; }
.motiv-text { font-size:0.9em; color:#555; margin-top:20px; }
.success { color:green; }
.none { color:#888; font-style:italic; }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
</script>
</head>

<body>
<div id="referral-container">
  <h1>ðŸŒŸ Parrainage</h1>
  <p>Partagez votre lien et gagnez automatiquement des bonus sur les achats de vos filleuls !</p>

  <div class="link-box">
    <span id="referral-link">Chargement...</span>
    <i class="fa fa-copy copy-btn" id="copyReferral"></i>
  </div>

  <p>Vos gains cumulÃ©s grÃ¢ce au parrainage : <span class="success" id="totalGains">0 USDT</span></p>

  <table class="table" id="referralTable">
    <thead>
      <tr>
        <th>Niveau</th>
        <th>Filleul</th>
        <th>Email</th>
        <th>Bonus ReÃ§u (USDT)</th>
      </tr>
    </thead>
    <tbody id="referralBody">
      <tr><td colspan="4" class="none">Chargement...</td></tr>
    </tbody>
  </table>

  <p class="motiv-text" id="motivText">Invitez vos amis et gagnez jusquâ€™Ã  20% sur leurs achats ! ðŸš€</p>
</div>

<script>
auth.onAuthStateChanged(async user=>{
  if(!user) return window.location.href="login.html";
  const uid = user.uid;
  const userRef = db.collection('users').doc(uid);

  userRef.onSnapshot(async doc=>{
    if(!doc.exists) return;
    const data = doc.data();
    const myCode = data.myReferralCode || "BRS-XXXX";
    const sponsors = [data.sponsor1, data.sponsor2, data.sponsor3];
    const wallet = data.wallet || {};
    const totalGainsEl = document.getElementById("totalGains");
    totalGainsEl.innerText = (wallet.totalGains || 0).toFixed(2) + " USDT";

    // Afficher lien de parrainage
    const linkEl = document.getElementById("referral-link");
    const link = `${window.location.origin}/register.html?ref=${myCode}`;
    linkEl.innerText = link;

    document.getElementById("copyReferral").addEventListener("click",()=>{
      navigator.clipboard.writeText(link).then(()=>alert("Lien copiÃ© !"));
    });

    // RÃ©cupÃ©rer les filleuls
    const tbody = document.getElementById("referralBody");
    tbody.innerHTML=""; // reset

    const filleuls = [];
    const querySnap = await db.collection("users").where("sponsor1","==",uid).get();
    querySnap.forEach(f=>filleuls.push({level:1,id:f.id,...f.data()}));
    const querySnap2 = await db.collection("users").where("sponsor2","==",uid).get();
    querySnap2.forEach(f=>filleuls.push({level:2,id:f.id,...f.data()}));
    const querySnap3 = await db.collection("users").where("sponsor3","==",uid).get();
    querySnap3.forEach(f=>filleuls.push({level:3,id:f.id,...f.data()}));

    if(filleuls.length===0){
      tbody.innerHTML=`<tr><td colspan="4" class="none">Vous nâ€™avez encore aucun filleul. Invitez vos amis pour commencer Ã  gagner !</td></tr>`;
    } else {
      for(const f of filleuls){
        // Bonus reÃ§u
        const bonusSnap = await db.collection("referralBonuses")
          .where("fromUser","==",f.id)
          .where("toUser","==",uid)
          .get();
        let totalBonus = 0;
        bonusSnap.forEach(b=>totalBonus += b.data().amount || 0);
        tbody.innerHTML += `<tr>
          <td>${f.level}</td>
          <td>${f.username || "â€”"}</td>
          <td>${f.email}</td>
          <td>${totalBonus.toFixed(2)}</td>
        </tr>`;
      }
    }
  });
});
</script>
</body>
  </html>
  
