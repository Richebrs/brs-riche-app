
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<title>D√©p√¥t - BRS RICHE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --primary:#0d47a1;
  --danger:#e53935;
  --ok:#2e7d32;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  font-family:"Segoe UI",Arial,sans-serif;
  background:#f4f7fb;
  display:flex;
  flex-direction:column;
  align-items:center;
  justify-content:flex-start;
  min-height:100vh;
  color:#222;
  user-select:none;
  padding:0 8px;
  opacity:0;
  transition:opacity .3s ease;
}
header{
  background:var(--primary);
  color:#fff;
  padding:14px 16px;
  width:100%;
  text-align:center;
  position:relative;
}
.back-btn{
  position:absolute;
  left:12px;
  top:50%;
  transform:translateY(-50%);
  color:#fff;
  text-decoration:none;
  font-weight:600;
}
main{
  max-width:480px;
  width:100%;
  margin-top:20px;
}
.card{
  background:#fff;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,0.08);
  padding:16px;
  margin-bottom:16px;
}
.card h2{
  text-align:center;
  color:var(--primary);
  margin-bottom:10px;
}
label{
  display:block;
  margin:10px 0 6px;
  font-weight:600;
}
input, select{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:15px;
}
.btn-primary{
  background:var(--primary);
  color:#fff;
  border:none;
  width:100%;
  padding:12px;
  border-radius:8px;
  margin-top:12px;
  font-weight:700;
  cursor:pointer;
}
.alert{display:none;padding:10px;border-radius:8px;margin-top:10px;text-align:center;}
.alert.error{background:#ffebee;color:#c62828;}
.alert.success{background:#e8f5e9;color:#1b5e20;}
.history-item{
  background:#fff;
  border-radius:8px;
  padding:12px;
  margin-bottom:10px;
  box-shadow:0 2px 6px rgba(0,0,0,0.06);
}
.status-ok{color:var(--ok);font-weight:700;}
.status-pending{color:#b8860b;font-weight:700;}
.no-data{text-align:center;color:#777;}
@media(max-width:520px){body{padding:0 8px}}
</style>
</head>

<body>
  <header>
    <a href="dashboard.html" class="back-btn">‚Üê Retour</a>
    <h1>üí∞ D√©p√¥t</h1>
  </header>

  <main>
    <div class="card">
      <h2>Effectuer un d√©p√¥t</h2>
      <label>Email</label>
      <input type="email" id="email" placeholder="Votre email" required>
      
      <label>Montant ($, min 5)</label>
      <input type="number" id="amount" min="5" placeholder="Entrez le montant (min 5$)" required>
      
      <label>R√©seau</label>
      <select id="network">
        <option value="BEP20">USDT BEP20</option>
        <option value="TRC20">USDT TRC20</option>
      </select>

      <label>Hash / ID de transaction</label>
      <input type="text" id="txHash" placeholder="Collez ici le hash ou ID" required>
      
      <div class="alert error" id="error"></div>
      <div class="alert success" id="success"></div>
      
      <button id="submit" class="btn-primary">‚úÖ J'ai pay√©</button>
    </div>

    <div class="card">
      <h3>üìú Historique de d√©p√¥ts</h3>
      <div id="history">
        <p class="no-data">Chargement...</p>
      </div>
    </div>
  </main>
</body>

  
<script>
/* ---------- CONFIGURATION ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const email = document.getElementById("email");
const amount = document.getElementById("amount");
const network = document.getElementById("network");
const txHash = document.getElementById("txHash");
const submit = document.getElementById("submit");
const errorBox = document.getElementById("error");
const successBox = document.getElementById("success");
const historyDiv = document.getElementById("history");

let currentUserId = null;

/* ---------- UTILITAIRES ---------- */
function showError(msg){
  errorBox.textContent = msg;
  errorBox.style.display = "block";
  successBox.style.display = "none";
  setTimeout(()=>errorBox.style.display="none",6000);
}
function showSuccess(msg){
  successBox.textContent = msg;
  successBox.style.display = "block";
  errorBox.style.display = "none";
  setTimeout(()=>successBox.style.display="none",6000);
}

/* ---------- AUTH ---------- */
auth.onAuthStateChanged(user=>{
  if(!user){ window.location.href = "login.html"; return; }
  document.body.style.opacity = 1;
  currentUserId = user.uid;

  // charger historique
  db.collection("deposits")
    .where("userId","==",currentUserId)
    .orderBy("createdAt","desc")
    .onSnapshot(renderHistory);
});

/* ---------- D√âP√îT ---------- */
submit.addEventListener("click", async ()=>{
  const amt = parseFloat(amount.value);
  const mail = email.value.trim();
  const net = network.value;
  const hash = txHash.value.trim();

  if(!mail) return showError("Entrez votre email.");
  if(isNaN(amt) || amt < 5) return showError("Montant minimum 5$.");
  if(hash.length < 10) return showError("Hash / ID invalide.");
  if(!confirm("Confirmez que vous avez bien effectu√© le paiement.")) return;

  try {
    // Envoi vers collection admin
    const depositRef = await db.collection("deposits").add({
      userId: currentUserId,
      email: mail,
      amount: amt,
      network: net,
      txHash: hash,
      status: "En attente",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Cr√©er aussi une copie pour admin (suivi)
    await db.collection("admin_deposits").doc(depositRef.id).set({
      userId: currentUserId,
      email: mail,
      amount: amt,
      network: net,
      txHash: hash,
      status: "En attente",
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    showSuccess("‚úÖ D√©p√¥t envoy√© √† l‚Äôadmin. En attente de validation.");
    amount.value = ""; txHash.value = ""; email.value = "";
  } catch(e){
    console.error(e);
    showError("Erreur d‚Äôenvoi du d√©p√¥t.");
  }
});

/* ---------- HISTORIQUE ---------- */
function renderHistory(snapshot){
  historyDiv.innerHTML = "";
  if(snapshot.empty){
    historyDiv.innerHTML = `<p class="no-data">Aucun d√©p√¥t trouv√©</p>`;
    return;
  }
  snapshot.forEach(doc=>{
    const d = doc.data();
    const statusClass = d.status==="Valid√©" ? "status-ok" : "status-pending";
    const date = d.createdAt?.toDate ? d.createdAt.toDate().toLocaleString() : "";
    const div = document.createElement("div");
    div.className = "history-item";
    div.innerHTML = `
      <div><strong>Montant:</strong> $${d.amount}</div>
      <div><strong>R√©seau:</strong> ${d.network}</div>
      <div><strong>Status:</strong> <span class="${statusClass}">${d.status}</span></div>
      <small>${date}</small>
    `;
    historyDiv.appendChild(div);
  });
}

/* ---------- AUTO-CR√âDIT APR√àS VALIDATION ADMIN ---------- */
db.collection("deposits")
  .where("userId","==",currentUserId)
  .onSnapshot(async snap=>{
    for(const doc of snap.docs){
      const data = doc.data();
      if(data.status === "Valid√©"){
        // cr√©dit automatique
        const userRef = db.collection("users").doc(currentUserId);
        const userDoc = await userRef.get();
        if(userDoc.exists){
          const oldBalance = userDoc.data().balance || 0;
          const newBalance = oldBalance + data.amount;
          await userRef.update({ balance: newBalance });
          await db.collection("deposits").doc(doc.id).update({ status:"Cr√©dit√©" });
        }
      }
    }
  });
</script>
</html>

