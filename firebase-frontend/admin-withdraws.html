<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Admin - Retraits</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
  <div class="max-w-4xl mx-auto mt-6 p-4 bg-white rounded-xl shadow-lg">
    <h2 class="text-2xl font-bold mb-4 text-center">ğŸ“‹ Gestion des Retraits</h2>
    <div id="withdrawalsList" class="space-y-3"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "XXX",
      authDomain: "XXX",
      projectId: "XXX",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const withdrawalsList = document.getElementById("withdrawalsList");

    // Copier lâ€™adresse
    function copyAddress(address) {
      navigator.clipboard.writeText(address).then(() => {
        alert("âœ… Adresse copiÃ©e : " + address);
      });
    }

    // Action admin
    async function updateWithdrawal(id, userId, amount, action, address) {
      try {
        const withdrawalRef = db.collection("withdrawals").doc(id);

        if (action === "success") {
          await withdrawalRef.update({ status: "success" });
          alert("âœ… Retrait validÃ©.");
        } else if (action === "refused") {
          // Remboursement automatique
          await db.collection("wallets").doc(userId).update({
            balance: firebase.firestore.FieldValue.increment(amount)
          });
          await withdrawalRef.update({ status: "refused" });
          alert("âŒ Retrait refusÃ©, montant remboursÃ©.");
        }
      } catch (err) {
        console.error(err);
        alert("Erreur admin !");
      }
    }

    // Charger retraits
    function loadWithdrawals() {
      db.collection("withdrawals")
        .orderBy("createdAt", "desc")
        .onSnapshot(async snapshot => {
          withdrawalsList.innerHTML = "";
          for (const doc of snapshot.docs) {
            const w = doc.data();
            const id = doc.id;
            const userSnap = await db.collection("users").doc(w.userId).get();
            const email = userSnap.exists ? userSnap.data().email : "inconnu";

            let color = w.status === "success" ? "text-green-600" :
                        w.status === "refused" ? "text-red-600" :
                        "text-yellow-600";

            withdrawalsList.innerHTML += `
              <div class="p-3 border rounded-lg shadow flex flex-col sm:flex-row justify-between items-start sm:items-center">
                <div class="mb-2 sm:mb-0">
                  <p><b>Utilisateur :</b> ${email}</p>
                  <p><b>Montant :</b> ${w.amount} USDT</p>
                  <p><b>Adresse :</b> <span class="font-mono">${w.address}</span></p>
                  <p><b>RÃ©seau :</b> ${w.network}</p>
                  <p><b>Status :</b> <span class="${color} font-bold">${w.status}</span></p>
                </div>
                <div class="flex space-x-2">
                  <button onclick="copyAddress('${w.address}')" class="bg-blue-500 text-white px-3 py-1 rounded">ğŸ“‹ Copier</button>
                  <button onclick="updateWithdrawal('${id}','${w.userId}',${w.amount},'success')" class="bg-green-500 text-white px-3 py-1 rounded">âœ… Valider</button>
                  <button onclick="updateWithdrawal('${id}','${w.userId}',${w.amount},'refused')" class="bg-red-500 text-white px-3 py-1 rounded">âŒ Refuser</button>
                </div>
              </div>
            `;
          }
        });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        // VÃ©rification admin
        db.collection("users").doc(user.uid).get().then(doc => {
          if (doc.exists && doc.data().role === "admin") {
            loadWithdrawals();
          } else {
            alert("â›” AccÃ¨s refusÃ© (non admin).");
            window.location.href = "login.html";
          }
        });
      } else {
        window.location.href = "login.html";
      }
    });
  </script>
</body>
</html>
