!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Gestion des Retraits</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
    th { background: #f5f5f5; }
    button { padding: 5px 10px; border-radius: 5px; margin: 2px; cursor: pointer; }
    .approve { background: green; color: white; }
    .reject { background: red; color: white; }
  </style>
</head>
<body>
  <h2>üíº Administration - Retraits</h2>
  <table>
    <thead>
      <tr>
        <th>Utilisateur</th>
        <th>Email</th>
        <th>Montant</th>
        <th>Frais</th>
        <th>Net</th>
        <th>R√©seau</th>
        <th>Adresse</th>
        <th>Date</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="withdrawList"></tbody>
  </table>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    // Config Firebase (BRS-Riche-2)
    const firebaseConfig = {
      apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
      authDomain: "brs-riche-2.firebaseapp.com",
      projectId: "brs-riche-2",
      storageBucket: "brs-riche-2.appspot.com",
      messagingSenderId: "313874599780",
      appId: "1:313874599780:web:xxxxxx"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Charger la liste des retraits en attente
    db.collection("withdrawals")
      .where("status", "==", "pending")
      .orderBy("createdAt", "desc")
      .onSnapshot(async (snapshot) => {
        const list = document.getElementById("withdrawList");
        list.innerHTML = "";
        for (const doc of snapshot.docs) {
          const data = doc.data();
          const userDoc = await db.collection("users").doc(data.userId).get();
          const userData = userDoc.exists ? userDoc.data() : {};

          const row = `
            <tr>
              <td>${data.username || "N/A"}</td>
              <td>${userData.email || "N/A"}</td>
              <td>${data.amount} USDT</td>
              <td>${data.fees.toFixed(2)} USDT</td>
              <td>${data.net.toFixed(2)} USDT</td>
              <td>${data.network}</td>
              <td>${data.wallet}</td>
              <td>${data.createdAt ? data.createdAt.toDate().toLocaleString() : "N/A"}</td>
              <td>
                <button class="approve" onclick="approveWithdraw('${doc.id}', '${data.userId}', ${data.amount})">‚úÖ Valider</button>
                <button class="reject" onclick="rejectWithdraw('${doc.id}', '${data.userId}', ${data.amount})">‚ùå Refuser</button>
              </td>
            </tr>
          `;
          list.innerHTML += row;
        }
      });

    // ‚úÖ Valider un retrait
    async function approveWithdraw(withdrawId, userId, amount) {
      await db.collection("withdrawals").doc(withdrawId).update({ status: "approved" });
      alert("‚úÖ Retrait valid√© avec succ√®s !");
    }

    // ‚ùå Refuser un retrait (recr√©dite le solde utilisateur)
    async function rejectWithdraw(withdrawId, userId, amount) {
      const userRef = db.collection("users").doc(userId);
      const userSnap = await userRef.get();
      if (userSnap.exists) {
        const userData = userSnap.data();
        await userRef.update({
          balance: (userData.balance || 0) + amount,
          totalWithdrawn: (userData.totalWithdrawn || 0) - amount
        });
      }
      await db.collection("withdrawals").doc(withdrawId).update({ status: "rejected" });
      alert("‚ùå Retrait refus√© et montant recr√©dit√© !");
    }
  </script>
</body>
</html>
