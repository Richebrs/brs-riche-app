
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin - Retraits | BRS Riche</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f6f8; }
    header { background:#1976d2; color:white; padding:15px; text-align:center; font-size:20px; }
    .container { padding:20px; }
    .filter { margin-bottom:15px; text-align:center; }
    .filter select { padding:8px; border-radius:5px; border:1px solid #ccc; }
    .card { background:white; padding:15px; margin-bottom:15px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .card h3 { margin:0 0 10px; }
    .actions { margin-top:10px; }
    .btn { padding:8px 12px; margin-right:8px; border:none; border-radius:5px; cursor:pointer; color:white; }
    .btn-accept { background:#2e7d32; }
    .btn-refuse { background:#c62828; }
    .status { font-weight:bold; margin-top:10px; }
    .status.pending { color:orange; }
    .status.approved { color:green; }
    .status.refused { color:red; }
    .copy-btn { background:#0d47a1; color:white; border:none; padding:4px 8px; border-radius:5px; cursor:pointer; margin-left:6px; font-size:12px; }
  </style>
</head>
<body>
<header>ğŸ’¸ Tableau de validation des retraits</header>

<div class="container">
  <div class="filter">
    <label for="statusFilter">Filtrer par statut :</label>
    <select id="statusFilter">
      <option value="all">Tous</option>
      <option value="En attente">En attente</option>
      <option value="SuccÃ¨s">SuccÃ¨s</option>
      <option value="AnnulÃ©">AnnulÃ©</option>
    </select>
  </div>
  <div id="withdrawals-container">
    <p>Chargement des retraits...</p>
  </div>
</div>

<audio id="notif-sound" src="https://www.soundjay.com/buttons/sounds/button-3.mp3" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src("https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src("https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// Config Firebase â€” utilise la mÃªme que pour les autres pages
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2",
  storageBucket: "brs-riche-2.appspot.com",
  messagingSenderId: "313874599780",
  appId: "1:313874599780:web:xxxxxx"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

const withdrawalsContainer = document.getElementById("withdrawals-container");
const statusFilter = document.getElementById("statusFilter");
const notifSound = document.getElementById("notif-sound");
let currentFilter = "all";
let seenIds = new Set();

// fonction pour copier texte
function copyText(text){
  navigator.clipboard.writeText(text).then(()=>alert("CopiÃ© !")).catch(err=>console.error("Erreur copie", err));
}

function renderWithdrawals(docs){
  withdrawalsContainer.innerHTML = "";
  const filtered = docs.filter(doc=>{
    const data = doc.data();
    if(currentFilter === "all") return true;
    return data.status === currentFilter;
  });

  if(filtered.length === 0){
    withdrawalsContainer.innerHTML = "<p>Aucun retrait trouvÃ©.</p>";
    return;
  }

  filtered.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement("div");
    card.className = "card";

    const statusClass = data.status === "En attente" ? "pending" :
                        data.status === "SuccÃ¨s" ? "approved" :
                        data.status === "AnnulÃ©" ? "refused" : "";

    // date format
    let createdAt = "-";
    if(data.createdAt && data.createdAt.toDate) {
      createdAt = data.createdAt.toDate().toLocaleString();
    } else if (data.createdAt) {
      createdAt = data.createdAt;
    }

    card.innerHTML = `
      <h3>ğŸ‘¤ ${data.email || "Utilisateur inconnu"}</h3>
      <p>ğŸ’µ Montant demandÃ© : <b>${data.amount || "-"}</b> USDT</p>
      <p>ğŸ’° Frais : ${data.fees || "0"} USDT</p>
      <p>âœ… Montant net : ${data.netAmount || "-"} USDT</p>
      <p>ğŸŒ RÃ©seau : ${data.network || "-"}</p>
      <p>ğŸ¦ Adresse retrait : ${data.address || "-"} 
         <button class="copy-btn" onclick="copyText('${data.address || ""}')">Copier</button></p>
      <p>ğŸ“… Date : ${createdAt}</p>
      <p class="status ${statusClass}">Statut : ${data.status || "Inconnu"}</p>
      <div class="actions">
        <button class="btn btn-accept" onclick="updateStatus('${doc.id}','SuccÃ¨s')">âœ… Accepter</button>
        <button class="btn btn-refuse" onclick="updateStatus('${doc.id}','AnnulÃ©')">âŒ Refuser</button>
      </div>
    `;
    withdrawalsContainer.appendChild(card);

    if(!seenIds.has(doc.id) && data.status === "En attente"){
      notifSound.play();
      seenIds.add(doc.id);
    }
  });
}

// Ã©coute temps rÃ©el
db.collection("withdrawals").orderBy("createdAt","desc")
  .onSnapshot(snapshot => {
    renderWithdrawals(snapshot.docs);
  });

// filtrer selon statut
statusFilter.addEventListener("change", e=>{
  currentFilter = e.target.value;
  db.collection("withdrawals").orderBy("createdAt","desc").get().then(snapshot=>{
    renderWithdrawals(snapshot.docs);
  });
});

// mise Ã  jour du statut
function updateStatus(docId, status) {
  db.collection("withdrawals").doc(docId).update({ status })
    .then(()=> {
      alert("Le retrait a Ã©tÃ© " + (status === "SuccÃ¨s" ? "acceptÃ© âœ…" : "refusÃ© âŒ"));
    })
    .catch(err => {
      console.error("Erreur update retrait:", err);
      alert("Erreur lors de la mise Ã  jour du statut");
    });
}

// vÃ©rifier que lâ€™admin est connectÃ© (optionnel, selon ton systÃ¨me dâ€™auth)
auth.onAuthStateChanged(user =>{
  if(!user){
    window.location.href = "login.html";
  } else {
    // tu peux vÃ©rifier que lâ€™utilisateur est bien admin
    // exemple : lire son rÃ´le dans users/{user.uid} puis refuser sâ€™il nâ€™est pas admin
    db.collection("users").doc(user.uid).get().then(doc=>{
      const d = doc.data();
      if(d.role !== "Admis") {
        alert("AccÃ¨s non autorisÃ©");
        window.location.href = "login.html";
      }
    });
  }
});
</script>
</body>
</html>

