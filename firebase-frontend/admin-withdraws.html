<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BRS Riche - Admin Retraits</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h2 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background-color: #f2f2f2; }
    button { padding: 5px 10px; margin: 2px; border-radius: 5px; cursor: pointer; }
    .approve { background-color: #4CAF50; color: white; }
    .reject { background-color: #f44336; color: white; }
    .pending { color: orange; font-weight: bold; }
    .approved { color: green; font-weight: bold; }
    .rejected { color: red; font-weight: bold; }
    .info { margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <h2>üõ† Admin - Gestion des Retraits</h2>
  <p class="info">Affiche toutes les demandes de retrait et permet de les approuver ou rejeter.</p>

  <table id="withdrawTable">
    <thead>
      <tr>
        <th>Utilisateur</th>
        <th>Montant</th>
        <th>Frais</th>
        <th>Net √† recevoir</th>
        <th>R√©seau</th>
        <th>Wallet</th>
        <th>Statut</th>
        <th>Date</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <p id="message" class="info"></p>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
      authDomain: "brs-riche-2.firebaseapp.com",
      projectId: "brs-riche-2",
      storageBucket: "brs-riche-2.appspot.com",
      messagingSenderId: "313874599780",
      appId: "1:313874599780:web:xxxxxx"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    const tableBody = document.querySelector("#withdrawTable tbody");
    const messageEl = document.getElementById("message");

    let isAdmin = false;

    // V√©rifier si l'utilisateur est admin
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        messageEl.innerHTML = "‚ö† Veuillez vous connecter en tant qu'admin.";
        return;
      }
      const userDoc = await db.collection("users").doc(user.uid).get();
      const data = userDoc.data();
      if (data && data.role === "Admin") {
        isAdmin = true;
        loadWithdrawals();
      } else {
        messageEl.innerHTML = "‚ùå Acc√®s refus√© : vous n'√™tes pas admin.";
      }
    });

    async function loadWithdrawals() {
      const snapshot = await db.collection("withdrawals")
        .orderBy("createdAt", "desc")
        .get();
      tableBody.innerHTML = "";
      snapshot.forEach(doc => {
        const w = doc.data();
        const date = w.createdAt ? w.createdAt.toDate().toLocaleString() : "-";
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${w.username}</td>
          <td>${w.amount}</td>
          <td>${w.fees}</td>
          <td>${w.net.toFixed(2)}</td>
          <td>${w.network}</td>
          <td>${w.wallet}</td>
          <td class="${w.status}">${w.status}</td>
          <td>${date}</td>
          <td>
            ${w.status === "pending" ? `
              <button class="approve" onclick="processWithdraw('${doc.id}', true)">‚úî</button>
              <button class="reject" onclick="processWithdraw('${doc.id}', false)">‚úñ</button>
            ` : "-"}
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    async function processWithdraw(docId, approve) {
      if (!isAdmin) return;

      const docRef = db.collection("withdrawals").doc(docId);
      const docSnap = await docRef.get();
      if (!docSnap.exists) return;

      const w = docSnap.data();
      if (approve) {
        // Approuver : changer statut
        await docRef.update({ status: "approved" });
        messageEl.innerHTML = `‚úÖ Retrait de ${w.username} approuv√©.`;
      } else {
        // Rejeter : remettre solde √† l'utilisateur
        const userRef = db.collection("users").doc(w.userId);
        const userSnap = await userRef.get();
        const userData = userSnap.data();
        await userRef.update({
          balance: (userData.balance || 0) + w.amount,
          totalWithdrawn: (userData.totalWithdrawn || 0) - w.amount
        });
        await docRef.update({ status: "rejected" });
        messageEl.innerHTML = `‚ùå Retrait de ${w.username} rejet√© et solde restaur√©.`;
      }
      loadWithdrawals();
    }
  </script>
</body>
  </html>
    
