
<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin - Gestion des Retraits</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
body {
  font-family: 'Segoe UI', sans-serif;
  background: #f4f7fb;
  margin: 0;
  padding: 0;
  display: none;
}
header {
  background: #0d47a1;
  color: #fff;
  padding: 18px;
  text-align: center;
  position: relative;
}
.back-btn {
  position: absolute;
  left: 15px;
  top: 18px;
  color: #fff;
  text-decoration: none;
  font-weight: bold;
  font-size: 1em;
}
.container {
  max-width: 850px;
  margin: 30px auto;
  background: #fff;
  padding: 20px;
  border-radius: 14px;
  box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}
h2 {
  text-align: center;
  color: #0d47a1;
  margin-bottom: 20px;
}
.filter {
  text-align: center;
  margin-bottom: 20px;
}
.filter button {
  background: #ff9800;
  color: #fff;
  border: none;
  border-radius: 10px;
  padding: 8px 15px;
  cursor: pointer;
  font-weight: bold;
}
.filter button:hover {
  background: #e68900;
}
.withdraw-list {
  list-style: none;
  padding: 0;
  margin: 0;
}
.withdraw-item {
  background: #f9fbff;
  padding: 15px;
  margin-bottom: 12px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.08);
}
.withdraw-item strong { color: #0d47a1; }
.status {
  font-weight: bold;
}
.status.Pending { color: #b07a00; }
.status.Success { color: #0c880c; }
.status.Failed { color: #d93025; }
.action-btns {
  margin-top: 10px;
  display: flex;
  justify-content: center;
  gap: 10px;
}
button {
  padding: 8px 12px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-size: .9em;
  font-weight: 600;
}
.validate { background: #0c880c; color: #fff; }
.reject { background: #d93025; color: #fff; }
.validate:hover { background: #0a6e0a; }
.reject:hover { background: #b0241f; }
.loading { opacity: .6; pointer-events: none; }
footer {
  text-align: center;
  margin-top: 30px;
}
footer button {
  background: #ff9800;
  color: #fff;
  padding: 10px 20px;
  border: none;
  border-radius: 10px;
  font-weight: bold;
  cursor: pointer;
}
footer button:hover {
  background: #e68900;
}
</style>
</head>
<body>
<header>
  <a href="dashboard.html" class="back-btn">‚¨Ö Retour</a>
  <h1>üõ†Ô∏è Gestion des Retraits</h1>
</header>

<div class="container">
  <h2>Demandes de retrait</h2>
  <div class="filter">
    <button id="show-pending">Afficher seulement les en attente</button>
    <button id="show-all">Afficher tout</button>
  </div>
  <ul id="withdraw-list" class="withdraw-list"></ul>
</div>

<footer>
  <button id="retour-btn">‚¨Ö Retour au Dashboard</button>
</footer>

<script>
document.body.style.display = "block";
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const auth = firebase.auth();

let showPendingOnly = true;

auth.onAuthStateChanged(user => {
  if (!user) return window.location.href = "login.html";
  loadWithdrawals();
});

document.getElementById("show-pending").addEventListener("click", () => {
  showPendingOnly = true;
  loadWithdrawals();
});
document.getElementById("show-all").addEventListener("click", () => {
  showPendingOnly = false;
  loadWithdrawals();
});

async function loadWithdrawals() {
  const list = document.getElementById("withdraw-list");
  list.innerHTML = "<p>‚è≥ Chargement des demandes...</p>";
  const snap = await db.collection("withdrawals").orderBy("createdAt", "desc").get();
  list.innerHTML = "";

  if (snap.empty) {
    list.innerHTML = "<p>Aucune demande trouv√©e.</p>";
    return;
  }

  snap.forEach(doc => {
    const w = doc.data(), id = doc.id;
    if (showPendingOnly && w.status !== "Pending") return;
    const date = w.createdAt ? w.createdAt.toDate().toLocaleString() : "‚Äî";
    const status = w.status || "Pending";

    const li = document.createElement("li");
    li.className = "withdraw-item";
    li.innerHTML = `
      <div><strong>Utilisateur :</strong> ${w.userId}</div>
      <div><strong>Montant :</strong> ${w.amount} USDT</div>
      <div><strong>R√©seau :</strong> ${w.network}</div>
      <div><strong>Adresse :</strong> ${w.address}</div>
      <div><strong>Frais :</strong> ${w.fee.toFixed(2)} USDT</div>
      <div><strong>Net √† payer :</strong> ${w.netReceived.toFixed(2)} USDT</div>
      <div><strong>Date :</strong> ${date}</div>
      <div><strong>Statut :</strong> <span class="status ${status}">${status}</span></div>
    `;

    if (status === "Pending") {
      const div = document.createElement("div");
      div.className = "action-btns";
      const vBtn = document.createElement("button");
      vBtn.className = "validate";
      vBtn.innerText = "‚úÖ Valider";
      const rBtn = document.createElement("button");
      rBtn.className = "reject";
      rBtn.innerText = "‚ùå Refuser";

      div.appendChild(vBtn);
      div.appendChild(rBtn);
      li.appendChild(div);

      vBtn.onclick = () => updateStatus(id, "Success", w);
      rBtn.onclick = () => updateStatus(id, "Failed", w, true);
    }
    list.appendChild(li);
  });
}

async function updateStatus(id, status, withdrawData, refund = false) {
  const btns = document.querySelectorAll("button");
  btns.forEach(b => b.classList.add("loading"));
  try {
    await db.collection("withdrawals").doc(id).update({ status });

    if (refund && withdrawData?.userId) {
      const userRef = db.collection("users").doc(withdrawData.userId);
      const userDoc = await userRef.get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        const wallet = userData.wallet || {};
        const currentBalance = wallet.balance || 0;
        await userRef.update({
          "wallet.balance": currentBalance + withdrawData.amount
        });
      }
    }

    alert(`‚úÖ Statut mis √† jour : ${status}`);
    loadWithdrawals();
  } catch (e) {
    alert("Erreur : " + e.message);
  } finally {
    btns.forEach(b => b.classList.remove("loading"));
  }
}

document.getElementById("retour-btn").addEventListener("click", () => {
  window.location.href = "dashboard.html";
});
</script>
</body>
</html>


