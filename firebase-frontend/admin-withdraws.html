<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Retraits</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f4f8;
    margin: 0;
    padding: 20px;
  }
  h2 { text-align: center; color: #2c3e50; }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 20px;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
  }
  th, td {
    padding: 12px;
    border-bottom: 1px solid #ddd;
    text-align: center;
  }
  th {
    background-color: #2980b9;
    color: white;
  }
  tr:hover { background-color: #f1f1f1; }
  button {
    padding: 6px 12px;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    margin: 2px;
  }
  .approve { background: #27ae60; color: white; }
  .reject { background: #e74c3c; color: white; }
  .message { text-align: center; margin-top: 15px; font-weight: bold; }
  .success { color: #27ae60; }
  .error { color: #e74c3c; }
</style>
</head>
<body>

<h2>üíº Administration des Retraits</h2>
<div class="message" id="message"></div>

<table>
  <thead>
    <tr>
      <th>Utilisateur</th>
      <th>Solde</th>
      <th>Gains totaux</th>
      <th>D√©j√† retir√©</th>
      <th>Montant</th>
      <th>Frais (5%)</th>
      <th>Net</th>
      <th>R√©seau</th>
      <th>Adresse</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="withdrawalsTable">
    <!-- Les retraits seront inject√©s ici -->
  </tbody>
</table>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
    authDomain: "brs-riche-2.firebaseapp.com",
    projectId: "brs-riche-2",
    storageBucket: "brs-riche-2.appspot.com",
    messagingSenderId: "313874599780",
    appId: "1:313874599780:web:xxxxxx"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();

  const withdrawalsTable = document.getElementById("withdrawalsTable");
  const messageDiv = document.getElementById("message");

  // V√©rification admin
  auth.onAuthStateChanged(async (user) => {
    if (!user) {
      messageDiv.innerHTML = "<span class='error'>‚ö† Veuillez vous connecter</span>";
      return;
    }
    const doc = await db.collection("users").doc(user.uid).get();
    if (!doc.exists || doc.data().role !== "admin") {
      messageDiv.innerHTML = "<span class='error'>‚ùå Acc√®s refus√© : vous n'√™tes pas admin</span>";
      return;
    }
    loadWithdrawals();
  });

  async function loadWithdrawals() {
    withdrawalsTable.innerHTML = "";
    const snapshot = await db.collection("withdrawals").orderBy("createdAt", "desc").get();
    snapshot.forEach(doc => {
      const w = doc.data();
      if (w.status === "pending") {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${w.username}</td>
          <td>${w.balance || 0}</td>
          <td>${w.totalGains || 0}</td>
          <td>${w.totalWithdrawn || 0}</td>
          <td>${w.amount}</td>
          <td>${w.fees.toFixed(2)}</td>
          <td>${w.net.toFixed(2)}</td>
          <td>${w.network}</td>
          <td>${w.wallet}</td>
          <td>
            <button class="approve" onclick="updateStatus('${doc.id}', 'approved')">‚úÖ Approuver</button>
            <button class="reject" onclick="updateStatus('${doc.id}', 'rejected')">‚ùå Refuser</button>
          </td>
        `;
        withdrawalsTable.appendChild(row);
      }
    });
  }

  async function updateStatus(id, status) {
    try {
      const docRef = db.collection("withdrawals").doc(id);
      const withdrawal = await docRef.get();
      if (!withdrawal.exists) return;
      const data = withdrawal.data();
      const userRef = db.collection("users").doc(data.userId);
      const userDoc = await userRef.get();
      if (!userDoc.exists) return;

      if (status === "approved") {
        await docRef.update({status: "approved"});
      } else if (status === "rejected") {
        // Rembourse le solde si rejet
        await userRef.update({
          balance: userDoc.data().balance + data.amount
        });
        await docRef.update({status: "rejected"});
      }
      messageDiv.innerHTML = `<span class='success'>Mise √† jour r√©ussie</span>`;
      loadWithdrawals();
    } catch (err) {
      messageDiv.innerHTML = `<span class='error'>Erreur: ${err.message}</span>`;
    }
  }
</script>

</body>
  </html>
  
