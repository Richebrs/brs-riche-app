<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin Retraits - BRS RICHE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family:'Segoe UI',sans-serif; margin:0; padding:0; background:#f4f7fb; color:#333; display:none; text-align:center; }
header { background:#0d47a1; color:#fff; padding:20px; position:relative; }
header h1 { margin:0; font-size:1.6em; }
.container { margin:30px auto; max-width:700px; background:#fff; padding:30px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.15); }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:10px; border:1px solid #ccc; font-size:0.95em; text-align:center; }
th { background:#0d47a1; color:#fff; }
button { padding:6px 12px; font-size:0.9em; color:#fff; border:none; border-radius:8px; cursor:pointer; }
.approve { background:#4caf50; }
.reject { background:#f44336; }
.msg { margin:10px 0; font-size:0.95em; }
.success { color:green; }
.error { color:red; }
.back-btn { margin-top:15px; display:inline-block; text-decoration:none; color:#0d47a1; font-weight:bold; }
</style>
</head>
<body>
<header>
  <h1>üíº Admin oui Retraits</h1>
  <a href="dashboard.html" class="back-btn">‚¨Ö Retour au Dashboard</a>
</header>

<div class="container">
  <p class="msg" id="message"></p>
  <table>
    <thead>
      <tr>
        <th>Utilisateur</th>
        <th>Montant</th>
        <th>Frais</th>
        <th>Net</th>
        <th>R√©seau</th>
        <th>Adresse</th>
        <th>Date</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="withdrawals-list"></tbody>
  </table>
</div>

<script>
document.body.style.display = "block";

// üîπ Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const messageEl = document.getElementById("message");
const withdrawalsListEl = document.getElementById("withdrawals-list");

// üîπ Auth listener
auth.onAuthStateChanged(user => {
  if (!user) return window.location.href = "login.html";

  // V√©rifier si admin
  db.collection("users").doc(user.uid).get().then(doc => {
    if (!doc.exists || doc.data().role !== "admin") {
      alert("Acc√®s refus√©. Admin uniquement.");
      return window.location.href = "dashboard.html";
    }

    // Charger toutes les demandes
    db.collection("withdrawals").orderBy("createdAt","desc").onSnapshot(snapshot => {
      withdrawalsListEl.innerHTML = "";
      snapshot.forEach(doc => {
        const tx = doc.data();
        const date = tx.createdAt ? tx.createdAt.toDate().toLocaleString() : "‚Äî";
        withdrawalsListEl.innerHTML += `
          <tr id="row-${doc.id}">
            <td>${tx.userId}</td>
            <td>${tx.amount}</td>
            <td>${tx.fee}</td>
            <td>${tx.netReceived}</td>
            <td>${tx.network}</td>
            <td>${tx.address}</td>
            <td>${date}</td>
            <td id="status-${doc.id}">${tx.status}</td>
            <td>
              ${tx.status === "Pending" ? `
              <button class="approve" onclick="approve('${doc.id}', ${tx.amount}, '${tx.userId}')">‚úÖ Approve</button>
              <button class="reject" onclick="reject('${doc.id}', ${tx.amount}, '${tx.userId}')">‚ùå Reject</button>` : ''}
            </td>
          </tr>`;
      });
    });
  });
});

// üîπ Approve retrait
async function approve(docId, amount, userId){
  try {
    const txRef = db.collection("withdrawals").doc(docId);
    await txRef.update({status:"Approved"});

    messageEl.innerText = "‚úÖ Retrait approuv√©.";
    messageEl.className = "msg success";

    // D√©biter le wallet si pas encore d√©bit√© (optionnel, selon logique front)
    const userRef = db.collection("users").doc(userId);
    const userSnap = await userRef.get();
    const wallet = userSnap.data().wallet || {};
    await userRef.update({
      "wallet.balance": (wallet.balance ?? 0) - amount,
      "wallet.totalWithdrawn": (wallet.totalWithdrawn ?? 0) + amount
    });

  } catch(e){
    messageEl.innerText = `‚ùå Erreur : ${e.message}`;
    messageEl.className = "msg error";
    console.error(e);
  }
}

// üîπ Reject retrait
async function reject(docId, amount, userId){
  try {
    const txRef = db.collection("withdrawals").doc(docId);
    await txRef.update({status:"Rejected"});

    messageEl.innerText = "‚ùå Retrait rejet√©.";
    messageEl.className = "msg success";

    // Optionnel : rembourser le montant si d√©j√† d√©bit√©
    const userRef = db.collection("users").doc(userId);
    const userSnap = await userRef.get();
    const wallet = userSnap.data().wallet || {};
    await userRef.update({
      "wallet.balance": (wallet.balance ?? 0) + amount,
      "wallet.totalWithdrawn": (wallet.totalWithdrawn ?? 0) - amount
    });

  } catch(e){
    messageEl.innerText = `‚ùå Erreur : ${e.message}`;
    messageEl.className = "msg error";
    console.error(e);
  }
}
</script>
</body>
</html>
