<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Admin Retraits - BRS Riche</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body {
  font-family:'Segoe UI',sans-serif; margin:0; padding:0;
  background:#f4f7fb; color:#333; display:none; text-align:center;
}
header {
  background:#0d47a1; color:#fff; padding:20px; position:relative;
}
header h1 { margin:0; font-size:1.6em; }
.container {
  margin:20px auto; max-width:600px; background:#fff;
  padding:20px; border-radius:16px; box-shadow:0 6px 16px rgba(0,0,0,0.15);
}
.history { margin-top:20px; text-align:center; }
.history h3 { margin-bottom:10px; color:#0d47a1; }
.history-list { list-style:none; padding:0; max-height:400px; overflow-y:auto; }
.history-list li {
  margin:5px 0; padding:10px; border-radius:8px;
  font-size:0.95em; display:flex; flex-direction:column;
  align-items:flex-start;
}
.status-pending { background:#fff3cd; color:#856404; }
.status-success { background:#d4edda; color:#155724; }
.status-failed { background:#f8d7da; color:#721c24; }
button.action-btn { margin-top:5px; padding:5px 10px; border:none; border-radius:8px; cursor:pointer; color:#fff; }
.btn-approve { background:#28a745; }
.btn-refuse { background:#dc3545; }
.copy-btn { cursor:pointer; color:#0d47a1; margin-left:5px; }
.user-email { font-weight:bold; margin-bottom:5px; }
</style>
</head>
<body>
<header>
  <h1>ðŸ’¼ Admin f- Retraits</h1>
</header>

<div class="container">
  <div class="history">
    <h3>Historique des retraits</h3>
    <ul class="history-list" id="history-list"></ul>
  </div>
</div>

<script>
document.body.style.display = "block";

const firebaseConfig = {
  apiKey: "AIzaSyCxna2jjk_5BKXnsCmJmwFsM388DeFUcNQ",
  authDomain: "brs-riche-2.firebaseapp.com",
  projectId: "brs-riche-2"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const historyListEl = document.getElementById("history-list");

auth.onAuthStateChanged(async user => {
  if (!user) return window.location.href="login.html";

  const userDoc = await db.collection("users").doc(user.uid).get();
  if(!userDoc.exists || userDoc.data().role !== "admin"){
    alert("AccÃ¨s refusÃ©"); window.location.href="login.html"; return;
  }

  db.collection("withdrawals").orderBy("createdAt","desc")
    .onSnapshot(async snapshot=>{
      historyListEl.innerHTML="";
      for(const doc of snapshot.docs){
        const tx = doc.data();
        const status = tx.status || "Pending";
        let statusClass = status==="Pending"?"status-pending":
                          status==="Success"?"status-success":"status-failed";
        let userData=null;
        try{ const uDoc=await db.collection("users").doc(tx.userId).get(); if(uDoc.exists) userData=uDoc.data(); } catch{}
        const email = userData?.email || "â€”";
        const li = document.createElement("li");
        li.className=statusClass;
        li.innerHTML=`<span class="user-email">${email}</span>
          <span>${tx.amount} USDT | ${tx.network} | ${tx.address}<i class="copy-btn" onclick="navigator.clipboard.writeText('${tx.address}')"><i class="fa fa-copy"></i></i></span>
          <span>Status: ${status}</span>`;

        if(status==="Pending"){
          const approveBtn=document.createElement("button");
          approveBtn.textContent="âœ” Valider";
          approveBtn.className="action-btn btn-approve";
          approveBtn.onclick=async ()=>{
            try{
              await doc.ref.update({status:"Success"});
              alert("Retrait validÃ© !");
            }catch(e){alert("Erreur : "+e.message);}
          };
          const refuseBtn=document.createElement("button");
          refuseBtn.textContent="âœ– Refuser";
          refuseBtn.className="action-btn btn-refuse";
          refuseBtn.onclick=async ()=>{
            try{
              await doc.ref.update({status:"RefusÃ©"});
              // remboursement automatique
              if(userData?.wallet?.balance!==undefined){
                await db.collection("users").doc(tx.userId).update({
                  "wallet.balance": userData.wallet.balance + tx.amount,
                  "wallet.totalWithdrawn": userData.wallet.totalWithdrawn - tx.amount
                });
              }
              alert("Retrait refusÃ© et remboursÃ© !");
            }catch(e){alert("Erreur : "+e.message);}
          };
          li.appendChild(approveBtn); li.appendChild(refuseBtn);
        }
        historyListEl.appendChild(li);
      }
    });
});
</script>
</body>
</html>

  
